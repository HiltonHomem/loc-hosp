<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Formulário de Contrato</title>
  <script src="https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 2rem; }
    h2 { text-align: center; }
    #dadosContrato p { margin: 0.5rem 0; }
    label { display: block; margin-top: 1rem; }
    input, textarea { width: 100%; padding: 0.5rem; box-sizing: border-box; }
    button { margin-top: 1.5rem; padding: 0.5rem 1rem; cursor: pointer; }
  </style>
</head>
<body>

  <h2>Formulário Complementar</h2>
  <div id="dadosContrato" style="background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;"></div>
  
  <form id="formulario-contrato">
    <label>Médico Responsável: <input name="medico_responsavel" required /></label>
    <label>Tipo de Cirurgia: <input name="tipo_cirurgia" required /></label>
    <label>Data da Cirurgia: <input type="date" name="data_cirurgia" required /></label>
    <label>Indicação (quem recomendou): <input name="indicacao" required /></label>

    <button type="submit">Salvar e Gerar PDF</button>
  </form>

  <div id="pdf-content" style="display:none;"></div>

  <script>
    const SUPABASE_URL = 'https://dqzpmwzcpvibjjastcik.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxenBtd3pjcHZpYmpqYXN0Y2lrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwODk5NDQsImV4cCI6MjA2NTY2NTk0NH0.sQBEbatxPszUV1KRbV5f7hCO5FJTOesjBllglbjeOYM';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const rentalId = urlParams.get('id');

    let dadosContrato = null;

    async function carregarContrato() {
      if (!rentalId) {
        alert('ID do contrato não encontrado na URL.');
        return;
      }
      const { data, error } = await supabaseClient
        .from('rentals')
        .select('*, customers(*), equipment(*)')
        .eq('id', rentalId)
        .single();

      if (error || !data) {
        console.error('Erro ao buscar contrato:', error);
        alert('Contrato não encontrado ou erro ao carregar.');
        return;
      }

      dadosContrato = data;
      const cliente = data.customers;
      const equipamento = data.equipment;
      
      document.getElementById('dadosContrato').innerHTML = `
        <p><strong>Contrato ID:</strong> ${dadosContrato.id}</p>
        <p><strong>Cliente:</strong> ${cliente.name}</p>
        <p><strong>Equipamento:</strong> ${equipamento.name}</p>
      `;

      // Preenche os campos se já existirem dados
      if (data.medico_responsavel) document.querySelector('[name="medico_responsavel"]').value = data.medico_responsavel;
      if (data.tipo_cirurgia) document.querySelector('[name="tipo_cirurgia"]').value = data.tipo_cirurgia;
      if (data.data_cirurgia) document.querySelector('[name="data_cirurgia"]').value = data.data_cirurgia;
      if (data.indicacao) document.querySelector('[name="indicacao"]').value = data.indicacao;
    }

    document.getElementById('formulario-contrato').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const campos = Object.fromEntries(formData.entries());

      const { error } = await supabaseClient
        .from('rentals')
        .update(campos)
        .eq('id', rentalId);

      if (error) {
        console.error('Erro ao salvar:', error);
        return alert('Erro ao salvar as informações.');
      }
      
      alert('Informações salvas com sucesso! A gerar PDF...');

      gerarPDF({ ...dadosContrato, ...campos });
    });

    function gerarPDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.text("Contrato de Locação de Equipamento", 105, 20, { align: "center" });

      doc.setFontSize(12);
      doc.text("LOCADOR(A):", 20, 40);
      doc.setFont("helvetica", "normal");
      doc.text("Gesthos - Locação Hospitalar", 20, 47);

      doc.setFont("helvetica", "bold");
      doc.text("LOCATÁRIO(A):", 105, 40);
      doc.setFont("helvetica", "normal");
      doc.text(`Nome: ${data.customers.name}`, 105, 47);
      doc.text(`Telefone: ${data.customers.phone || 'N/A'}`, 105, 54);
      doc.text(`Email: ${data.customers.email || 'N/A'}`, 105, 61);

      doc.setLineWidth(0.5);
      doc.line(20, 75, 190, 75);

      doc.setFont("helvetica", "bold");
      doc.text("1. OBJETO DO CONTRATO", 20, 85);
      doc.setFont("helvetica", "normal");
      doc.text(`O presente contrato tem como objeto a locação do seguinte equipamento:`, 20, 92);
      doc.setFont("helvetica", "bold");
      doc.text(`- Equipamento: ${data.equipment.name}`, 25, 100);
      
      doc.setFont("helvetica", "bold");
      doc.text("2. PRAZO E VALOR", 20, 115);
      doc.setFont("helvetica", "normal");
      doc.text(`- Período da Locação: De ${new Date(data.rental_start_date).toLocaleDateString()} até ${new Date(data.expected_return_date).toLocaleDateString()}.`, 20, 122);
      doc.text(`- Valor Total do Contrato: ${data.total_price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}.`, 20, 129);

      doc.setFont("helvetica", "bold");
      doc.text("3. INFORMAÇÕES COMPLEMENTARES", 20, 144);
      doc.setFont("helvetica", "normal");
      doc.text(`- Médico Responsável: ${data.medico_responsavel}`, 25, 151);
      doc.text(`- Tipo de Cirurgia: ${data.tipo_cirurgia}`, 25, 158);
      doc.text(`- Data da Cirurgia: ${new Date(data.data_cirurgia).toLocaleDateString()}`, 25, 165);
      doc.text(`- Indicação: ${data.indicacao}`, 25, 172);

      doc.setFont("helvetica", "bold");
      doc.text("4. CLÁUSULAS GERAIS", 20, 187);
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      const clauses = `O LOCATÁRIO obriga-se a zelar pela conservação do equipamento alugado, utilizando-o de acordo com as suas especificações. Qualquer dano causado por mau uso será de responsabilidade do LOCATÁRIO. O equipamento deve ser devolvido nas mesmas condições em que foi recebido, salvo o desgaste natural pelo uso regular.`;
      const splitClauses = doc.splitTextToSize(clauses, 170);
      doc.text(splitClauses, 20, 194);

      doc.line(30, 240, 90, 240);
      doc.text("Assinatura do Locador", 45, 245);
      doc.line(120, 240, 180, 240);
      doc.text("Assinatura do Locatário", 130, 245);

      doc.save(`Contrato_${data.id}_${data.customers.name.replace(/\s/g, '_')}.pdf`);
    }

    carregarContrato();
  </script>
</body>
</html>