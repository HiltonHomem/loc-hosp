<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Bio Poltronas Niteroi </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        .content { transition: margin-left 0.3s ease-in-out; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        
        .filter-btn, .view-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            background-color: white;
            color: #4a5568;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .filter-btn.active-filter, .view-btn.active-view {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Estilos para a notificação Toast */
        .toast {
            transform: translateX(110%);
            transition: transform 0.5s ease-in-out;
        }
        .toast.show {
            transform: translateX(0);
        }
    </style>
    <script type="module">
        // --- SCRIPT DE VERIFICAÇÃO DE SESSÃO SUPABASE ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            window.location.href = './login.html';
        }

        // Adiciona o evento de logout ao botão
        document.getElementById('logout-button').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = './login.html';
        });
    </script>
</head>
<body class="bg-gray-100 md:flex">

    <aside id="sidebar" class="sidebar sidebar-closed md:sidebar-open bg-slate-800 text-white w-64 fixed inset-y-0 left-0 z-30 md:relative md:translate-x-0 shrink-0">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-center">Bio Poltronas</h1>
            <p class="text-sm text-center text-slate-400">Locação</p>
        </div>
        <nav class="mt-8">
            <a href="#catalogo" class="flex items-center px-6 py-3 text-slate-200 hover:bg-slate-700 nav-link">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg> Catálogo
            </a>
            <a href="#disponibilidade" class="flex items-center px-6 py-3 text-slate-200 hover:bg-slate-700 nav-link">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Disponibilidade
            </a>
            <a href="#contratos" class="flex items-center px-6 py-3 text-slate-200 hover:bg-slate-700 nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg> Contratos
            </a>
             <a href="#historico" class="flex items-center px-6 py-3 text-slate-200 hover:bg-slate-700 nav-link">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Histórico
            </a>
             <a href="#clientes" class="flex items-center px-6 py-3 text-slate-200 hover:bg-slate-700 nav-link">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.225-1.26-.624-1.742M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-2 9h4"></path></svg> Clientes
            </a>
            <a href="#fluxo-caixa" class="flex items-center px-6 py-3 text-slate-200 hover:bg-slate-700 nav-link">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> Fluxo de Caixa
            </a>
        </nav>
        <!-- BOTÃO DE SAIR -->
        <div class="p-6 mt-auto">
             <button id="logout-button" class="w-full flex items-center justify-center px-4 py-2 text-slate-200 bg-red-600 rounded-lg hover:bg-red-700">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Sair
            </button>
        </div>
    </aside>

    <div class="flex flex-col flex-1">
        <header class="bg-white shadow-sm flex justify-between items-center p-4">
            <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
            <h2 id="page-title" class="text-xl font-semibold text-gray-800">Catálogo</h2>
            <div><button id="make-rental-header-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Fazer Locação</button></div>
        </header>
        
        <main id="main-content" class="flex-1 p-6 overflow-y-auto">
            <section id="historico" class="page-section hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-lg font-semibold">Histórico de Locações (Concluídas)</h3>
                         <div class="flex items-center gap-4 w-full md:w-auto">
                           <div class="flex items-center gap-2">
                                <label for="history-sort" class="text-sm font-medium text-gray-700">Ordenar por:</label>
                                <select id="history-sort" class="border-gray-300 rounded-md shadow-sm text-sm">
                                    <option value="created_at-desc">Mais Recentes</option>
                                    <option value="expected_return_date-asc">Devolução Prevista</option>
                                    <option value="total_price-desc">Maior Valor</option>
                                </select>
                            </div>
                            <input type="search" id="history-search" placeholder="Buscar..." class="w-full md:w-auto px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 text-left">Equipamento</th>
                                    <th class="py-2 px-4 text-left">Cliente</th>
                                    <th class="py-2 px-4 text-left">Início</th>
                                    <th class="py-2 px-4 text-left">Dev. Prevista</th>
                                    <th class="py-2 px-4 text-left">Dev. Real</th>
                                    <th class="py-2 px-4 text-right">Valor Total</th>
                                    <th class="py-2 px-4 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="rental-history-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="catalogo" class="page-section">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h3 class="text-lg font-semibold">Itens do Catálogo</h3>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center">
                            <button id="grid-view-btn" class="view-btn p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                            </button>
                            <button id="list-view-btn" class="view-btn active-view p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                            </button>
                        </div>
                        <button id="add-equipment-catalog-button" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700">Adicionar Equipamento</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-4">
                        <div class="flex flex-wrap items-center gap-2" id="catalog-filters">
                             <span class="font-semibold text-gray-700">Status:</span>
                            <button class="filter-btn active-filter" data-status="Todos">Todos</button>
                            <button class="filter-btn" data-status="Disponível">Disponíveis</button>
                            <button class="filter-btn" data-status="Alugado">Alugados</button>
                            <button class="filter-btn" data-status="Em Reparo">Em Manutenção</button>
                        </div>
                        <input type="search" id="catalog-search" placeholder="Buscar por nome..." class="w-full md:w-1/3 px-3 py-2 border rounded-lg">
                    </div>
                     <div class="border-t pt-4">
                        <div class="flex flex-wrap items-center gap-4">
                            <span class="font-semibold text-gray-700">Verificar disponibilidade no período:</span>
                            <div class="flex items-center gap-2">
                                <label for="filter-start-date" class="text-sm text-gray-600">De:</label>
                                <input type="date" id="filter-start-date" class="border rounded-lg px-2 py-1 text-sm">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="filter-end-date" class="text-sm text-gray-600">Até:</label>
                                <input type="date" id="filter-end-date" class="border rounded-lg px-2 py-1 text-sm">
                            </div>
                            <button id="apply-date-filter" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg shadow hover:bg-blue-700 text-sm">Filtrar</button>
                            <button id="clear-date-filter" class="bg-gray-200 text-gray-700 px-4 py-1.5 rounded-lg hover:bg-gray-300 text-sm">Limpar</button>
                        </div>
                    </div>
                </div>
                <div id="grid-view-container" class="hidden">
                <div id="equipment-list-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </div>
                    <div id="list-view-container" class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 text-left">Equipamento</th>
                                    <th class="py-2 px-4 text-left">Status</th>
                                    
                                    <th class="py-2 px-4 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="equipment-list-table"></tbody>
                        </table>
                    </div>
            </section>
            
            <section id="disponibilidade" class="page-section hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-lg font-semibold">Controle de Disponibilidade</h3>
                         <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="flex items-center gap-2">
                                <label for="availability-sort" class="text-sm font-medium text-gray-700">Ordenar por:</label>
                                <select id="availability-sort" class="border-gray-300 rounded-md shadow-sm text-sm">
                                    <option value="name-asc">Nome (A-Z)</option>
                                    <option value="name-desc">Nome (Z-A)</option>
                                    <option value="status-asc">Status</option>
                                </select>
                            </div>
                            <input type="search" id="availability-search" placeholder="Buscar por equipamento..." class="w-full md:w-auto px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                     <div class="flex items-center gap-2 mb-4" id="availability-status-filters">
                        <span class="font-medium text-gray-700">Status:</span>
                        <button class="filter-btn active-filter" data-status="Todos">Todos</button>
                        <button class="filter-btn" data-status="Disponível">Disponível</button>
                        <button class="filter-btn" data-status="Alugado">Alugado</button>
                        <button class="filter-btn" data-status="Em Reparo">Em Reparo</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Equipamento</th><th class="py-2 px-4 text-left">Status</th><th class="py-2 px-4 text-left">Cliente</th><th class="py-2 px-4 text-left">Devolução</th><th class="py-2 px-4 text-center">Ações</th></tr></thead>
                            <tbody id="availability-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="clientes" class="page-section hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-lg font-semibold">Clientes Cadastrados</h3>
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="flex items-center gap-2">
                                <label for="customers-sort" class="text-sm font-medium text-gray-700">Ordenar por:</label>
                                <select id="customers-sort" class="border-gray-300 rounded-md shadow-sm text-sm">
                                    <option value="name-asc">Nome (A-Z)</option>
                                    <option value="name-desc">Nome (Z-A)</option>
                                    <option value="email-asc">Email</option>
                                </select>
                            </div>
                            <input type="search" id="customers-search" placeholder="Buscar por nome..." class="w-full md:w-auto px-3 py-2 border rounded-lg">
                            <button id="add-customer-button" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 whitespace-nowrap">Adicionar Cliente</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 border-t pt-4 mb-4">
                        <div class="flex items-center gap-2" id="customer-status-filters">
                            <span class="font-medium text-gray-700">Status Cadastral:</span>
                            <button class="filter-btn active-filter" data-status="Todos">Todos</button>
                            <button class="filter-btn" data-status="ativo">Ativo</button>
                             <button class="filter-btn" data-status="pendente">Pendente</button>
                            <button class="filter-btn" data-status="link_gerado">Aguardando Cadastro</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200"><tr><th class="py-2 px-4 text-left">Nome</th><th class="py-2 px-4 text-left">Telefone</th><th class="py-2 px-4 text-left">Status Cadastral</th><th class="py-2 px-4 text-center">Status Locação</th><th class="py-2 px-4 text-center">Ações</th></tr></thead>
                            <tbody id="customers-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="contratos" class="page-section hidden">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Contratos Ativos e Agendados</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 text-left">Equipamento</th>
                                    <th class="py-2 px-4 text-left">Cliente</th>
                                    <th class="py-2 px-4 text-left">Início</th>
                                    <th class="py-2 px-4 text-left">Devolução Prevista</th>
                                    <th class="py-2 px-4 text-left">Status</th>
                                    <th class="py-2 px-4 text-right">Valor do Contrato</th>
                                    <th class="py-2 px-4 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="contracts-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="fluxo-caixa" class="page-section hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-500">Receita Prevista (Mês Atual)</h4>
                        <p id="forecast-income" class="text-2xl font-bold text-blue-600">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-500">Renda Prevista (Contratos Agendados)</h4>
                        <p id="future-income" class="text-2xl font-bold text-cyan-600">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-gray-500">Balanço Geral (Realizado)</h4>
                        <p id="total-balance" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Histórico de Transações</h3>
                        <button id="add-expense-button" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700">Adicionar Despesa</button>
                    </div>
                     <div class="flex flex-wrap items-center gap-x-6 gap-y-4 border-b pb-4 mb-4">
                        <div class="flex items-center gap-2" id="cashflow-type-filters">
                             <span class="font-medium text-gray-700">Tipo:</span>
                            <button class="filter-btn active-filter" data-type="Todos">Todos</button>
                            <button class="filter-btn" data-type="Entrada">Entradas</button>
                            <button class="filter-btn" data-type="Saída">Saídas</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="filter-cashflow-start" class="text-sm text-gray-600">De:</label>
                            <input type="date" id="filter-cashflow-start" class="border rounded-lg px-2 py-1 text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="filter-cashflow-end" class="text-sm text-gray-600">Até:</label>
                            <input type="date" id="filter-cashflow-end" class="border rounded-lg px-2 py-1 text-sm">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 text-left">Data</th>
                                    <th class="py-2 px-4 text-left">Descrição</th>
                                    <th class="py-2 px-4 text-left">Tipo</th>
                                    <th class="py-2 px-4 text-right">Valor</th>
                                    <th class="py-2 px-4 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="cash-flow-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 pt-4 border-t-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <h4 class="text-gray-500 font-semibold">Total de Entradas (Período)</h4>
                            <p id="total-income" class="text-xl font-bold text-green-600">R$ 0,00</p>
                        </div>
                        <div>
                            <h4 class="text-gray-500 font-semibold">Total de Saídas (Período)</h4>
                            <p id="total-expenses" class="text-xl font-bold text-red-600">R$ 0,00</p>
                        </div>
                        <div>
                            <h4 class="text-gray-500 font-semibold">Saldo (Período)</h4>
                            <p id="net-balance" class="text-xl font-bold text-blue-600">R$ 0,00</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="customer-add-choice-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Como deseja adicionar o cliente?</h2><div class="flex justify-around space-x-4"><button type="button" id="add-customer-manually-button" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">Adicionar Manualmente</button><button type="button" id="generate-customer-link-button" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700">Gerar Link de Cadastro</button></div><button type="button" class="cancel-modal-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button></div></div>
    
    <div id="generated-link-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-bold mb-4">Link de Cadastro Gerado</h2><p class="mb-4 text-gray-600">Envie o link abaixo para o cliente. Ele será válido por 24 horas.</p><div class="flex items-center bg-gray-100 p-2 rounded-lg"><input type="text" id="generated-link-input" readonly class="w-full bg-transparent border-none text-gray-700 focus:ring-0"><button id="copy-link-button" class="ml-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Copiar</button></div><div class="text-right mt-6"><button type="button" class="cancel-modal-button px-6 py-2 bg-gray-300 rounded-lg">Fechar</button></div></div></div>

    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4" id="confirmation-title">Confirmar Ação</h2><p id="confirmation-message" class="mb-6">Tem a certeza que deseja prosseguir?</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-confirmation-button" class="px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="button" id="confirm-action-button" class="px-4 py-2 bg-red-600 text-white rounded-lg">Confirmar</button></div></div></div>
    <div id="extend-rental-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Estender Contrato</h2><form id="extend-rental-form" class="space-y-4"><input type="hidden" name="rental_id"><input type="hidden" name="equipment_id"><input type="hidden" name="original_return_date"><input type="hidden" name="daily_price"><input type="hidden" name="start_date"><div><label class="block text-gray-700">Equipamento</label><p id="extend-equipment-name" class="text-lg font-semibold"></p></div><div><label for="new-return-date" class="block text-gray-700">Nova Data de Devolução</label><input type="date" id="new-return-date" name="new_return_date" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-gray-700">Desconto Adicional (R$)</label><input type="number" id="extend-discount" name="discount" class="w-full px-3 py-2 border rounded-lg" step="0.01" placeholder="0.00"></div><div class="mt-4 pt-4 border-t"><p class="text-lg font-semibold text-gray-800">Valor Total Atualizado: <span id="extend-total-price" class="text-blue-600">R$ 0,00</span></p></div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Confirmar Extensão</button></div></form></div></div>
    <div id="equipment-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-start mb-4"><h2 class="text-2xl font-bold equipment-name"></h2><button type="button" class="cancel-modal-button text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button></div><div class="flex-grow overflow-y-auto"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><img src="https://placehold.co/600x400" alt="Equipment Image" class="equipment-image w-full h-64 object-cover rounded-lg mb-4"><div><h3 class="font-semibold text-lg border-b pb-2 mb-2">Preço</h3><p class="text-2xl font-bold text-blue-600 equipment-price"></p><h3 class="font-semibold text-lg border-b pb-2 mb-2 mt-4">Data de Aquisição</h3><p class="text-gray-700 equipment-acquisition-date"></p><h3 class="font-semibold text-lg border-b pb-2 mb-2 mt-4">Descrição</h3><p class="text-gray-700 equipment-description mb-4"></p><h3 class="font-semibold text-lg border-b pb-2 mb-2">Informações Adicionais</h3><p class="text-gray-700 equipment-additional-info"></p></div></div><div class="mt-6"><h3 class="font-semibold text-lg border-b pb-2 mb-2">Histórico de Locações</h3><div class="overflow-x-auto max-h-48"><table class="min-w-full bg-white"><thead class="bg-gray-200 sticky top-0"><tr><th class="py-2 px-4 text-left">Cliente</th><th class="py-2 px-4 text-left">Início</th><th class="py-2 px-4 text-left">Fim</th><th class="py-2 px-4 text-left">Status</th></tr></thead><tbody id="equipment-rental-history-table"></tbody></table></div></div></div><div class="flex justify-end space-x-4 pt-6 mt-auto border-t"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Fechar</button><button type="button" class="edit-button-modal bg-yellow-400 text-yellow-900 hover:bg-yellow-500 font-semibold py-2 px-4 rounded-lg">Editar Equipamento</button></div></div></div>
    <div id="add-equipment-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Adicionar Equipamento</h2><form id="add-equipment-form" class="space-y-4"><div><label class="block text-gray-700">Nome</label><input type="text" name="name" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-gray-700">Descrição</label><textarea name="description" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea></div><div><label class="block text-gray-700">Informações Adicionais</label><textarea name="additional_info" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea></div><div><label class="block text-gray-700">URL da Imagem</label><input type="text" name="image_url" class="w-full px-3 py-2 border rounded-lg"></div><div><label class="block text-gray-700">Data de Aquisição</label><input type="date" name="acquisition_date" class="w-full px-3 py-2 border rounded-lg" required></div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Salvar</button></div></form></div></div>
    <div id="edit-equipment-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Editar Equipamento</h2><form id="edit-equipment-form" class="space-y-4"><input type="hidden" name="id"><div><label class="block text-gray-700">Nome</label><input type="text" id="edit-name" name="name" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-gray-700">Descrição</label><textarea id="edit-description" name="description" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea></div><div><label class="block text-gray-700">Informações Adicionais</label><textarea id="edit-additional-info" name="additional_info" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea></div><div><label class="block text-gray-700">URL da Imagem</label><input type="text" id="edit-image_url" name="image_url" class="w-full px-3 py-2 border rounded-lg"></div><div><label class="block text-gray-700">Status</label><select id="edit-status" name="status" class="w-full px-3 py-2 border rounded-lg" required><option value="Disponível">Disponível</option><option value="Alugado">Alugado</option><option value="Em Reparo">Em Reparo</option></select></div><div><label class="block text-gray-700">Data de Aquisição</label><input type="date" id="edit-acquisition_date" name="acquisition_date" class="w-full px-3 py-2 border rounded-lg" required></div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg">Salvar Alterações</button></div></form></div></div>
    <div id="add-customer-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Adicionar Cliente Manualmente</h2><form id="add-customer-form" class="space-y-4"><div><label class="block text-gray-700">Nome</label><input type="text" id="customer-name" name="name" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-gray-700">Telefone</label><input type="tel" id="customer-phone" name="phone" class="w-full px-3 py-2 border rounded-lg"></div><div><label class="block text-gray-700">Email</label><input type="email" id="customer-email" name="email" class="w-full px-3 py-2 border rounded-lg"></div><div><label class="block text-gray-700">Endereço</label><textarea id="customer-address" name="address" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea></div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg">Salvar</button></div></form></div></div>
<div id="edit-customer-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <h2 class="text-2xl font-bold mb-6">Editar Cliente</h2>
        <form id="edit-customer-form" class="space-y-4">
          <input type="hidden" name="id" id="edit-customer-id">
          
          <h4 class="text-lg font-medium text-gray-800 mb-2 border-b pb-2">Informações de Contato</h4>
          <div><label for="edit-name" class="block text-sm font-medium text-gray-700">Nome Completo:</label><input type="text" id="edit-name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></div>
          <div class="grid grid-cols-2 gap-4">
            <div><label for="edit-phone" class="block text-sm font-medium text-gray-700">Telefone (com DDD):</label><input type="tel" id="edit-phone" name="phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
            <div><label for="edit-email" class="block text-sm font-medium text-gray-700">Email:</label><input type="email" id="edit-email" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
          </div>
          <div><label for="edit-address" class="block text-sm font-medium text-gray-700">Endereço (antigo, referência):</label><textarea id="edit-address" name="address" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea></div>

          <hr class="my-6">
          <h4 class="text-lg font-medium text-gray-800 mb-2 border-b pb-2">Detalhes Pessoais e Endereço</h4>

          <div class="grid grid-cols-2 gap-4">
            <div><label for="edit-cpf" class="block text-sm font-medium text-gray-700">CPF:</label><input type="text" id="edit-cpf" name="cpf" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
            <div><label for="edit-rg" class="block text-sm font-medium text-gray-700">RG:</label><input type="text" id="edit-rg" name="rg" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
            <div><label for="edit-profissao" class="block text-sm font-medium text-gray-700">Profissão:</label><input type="text" id="edit-profissao" name="profissao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
            <div><label for="edit-nacionalidade" class="block text-sm font-medium text-gray-700">Nacionalidade:</label><input type="text" id="edit-nacionalidade" name="nacionalidade" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
            <div><label for="edit-estado_civil" class="block text-sm font-medium text-gray-700">Estado Civil:</label><input type="text" id="edit-estado_civil" name="estado_civil" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
          </div>
          <div><label for="edit-endereco_completo" class="block text-sm font-medium text-gray-700">Endereço Completo (Rua, Nº, Bairro, CEP):</label><input type="text" id="edit-endereco_completo" name="endereco_completo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
          <div><label for="edit-cidade" class="block text-sm font-medium text-gray-700">Cidade/Estado:</label><input type="text" id="edit-cidade" name="cidade" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
          
          <hr class="my-6">
          <h4 class="text-lg font-medium text-gray-800 mb-2 border-b pb-2">Informações Médicas</h4>

          <div><label for="edit-medico_responsavel" class="block text-sm font-medium text-gray-700">Médico Responsável:</label><input type="text" id="edit-medico_responsavel" name="medico_responsavel" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
          <div class="grid grid-cols-2 gap-4">
            <div><label for="edit-tipo_cirurgia" class="block text-sm font-medium text-gray-700">Tipo de Cirurgia:</label><input type="text" id="edit-tipo_cirurgia" name="tipo_cirurgia" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
            <div><label for="edit-data_cirurgia" class="block text-sm font-medium text-gray-700">Data da Cirurgia:</label><input type="date" id="edit-data_cirurgia" name="data_cirurgia" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
          </div>
          <div><label for="edit-indicacao" class="block text-sm font-medium text-gray-700">Indicação (quem recomendou):</label><input type="text" id="edit-indicacao" name="indicacao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>

          <!-- NEW SECTION FOR DOCUMENTS -->
          <hr class="my-6">
          <h4 class="text-lg font-medium text-gray-800 mb-2 border-b pb-2">Documentos</h4>
          <div class="space-y-4">
              <div>
                  <label class="block text-sm font-medium text-gray-700">Comprovante de Residência</label>
                  <div id="edit-customer-comprovante-status" class="mt-1 text-sm text-gray-600">Carregando...</div>
                  <input type="file" name="new_comprovante_residencia" accept=".pdf,.jpg,.jpeg,.png" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
              </div>
              <div>
                  <label class="block text-sm font-medium text-gray-700">Documento de Identidade</label>
                  <div id="edit-customer-documento-status" class="mt-1 text-sm text-gray-600">Carregando...</div>
                  <input type="file" name="new_documento_identidade" accept=".pdf,.jpg,.jpeg,.png" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
              </div>
          </div>
          <!-- END OF NEW SECTION -->


          <div class="flex justify-end space-x-4 pt-4">
            <button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button>
            <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg">Salvar Alterações</button>
          </div>
        </form>
      </div>
    </div>    <div id="new-rental-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Nova Locação</h2><form id="new-rental-form" class="space-y-4"><input type="hidden" name="equipment_id"><input type="hidden" name="rental_price"><div><label class="block text-gray-700">Equipamento</label><p id="rental-equipment-name" class="text-lg font-semibold"></p></div><div><label class="block text-gray-700">Cliente</label><select name="customer_id" id="rental-customer" class="w-full px-3 py-2 border rounded-lg" required></select></div><div><label class="block text-gray-700">Início da Locação</label><input type="date" id="rental-start-date" name="rental_start_date" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-gray-700">Devolução Prevista</label><input type="date" id="rental-return-date" name="expected_return_date" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-gray-700">Desconto (R$)</label><input type="number" id="rental-discount" name="discount" class="w-full px-3 py-2 border rounded-lg" step="0.01" placeholder="0.00"></div><div class="mt-4 pt-4 border-t">
        <div>
        <label class="block text-gray-700">Novo Valor da Locação (R$)</label>
        <input type="number" name="total_price" class="w-full px-3 py-2 border rounded-lg" step="0.01" required>
        </div>
        <div>
        <label class="block text-gray-700">Valor do Frete (R$)</label>
        <input type="number" name="freight" class="w-full px-3 py-2 border rounded-lg" step="0.01" placeholder="0.00">
        </div>
        <div class="mt-4 text-right">
        <p class="text-lg font-semibold text-gray-800">Valor Total: <span id="calculated-total" class="text-blue-600">R$ 0,00</span></p>
        </div>

</div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Confirmar</button></div></form></div></div>
    
        <!-- MODAL DE EDIÇÃO DE CONTRATO - MODIFICADO -->
    <div id="edit-contract-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Editar Contrato</h2>
            <form id="edit-contract-form" class="space-y-4">
                <input type="hidden" name="rental_id">
                <input type="hidden" name="daily_price">
                <input type="hidden" name="start_date">
                <div>
                    <label class="block text-gray-700">Equipamento</label>
                    <p id="edit-contract-equipment-name" class="text-lg font-semibold"></p>
                </div>
                <div>
                    <label class="block text-gray-700">Cliente</label>
                    <select name="customer_id" id="edit-contract-customer" class="w-full px-3 py-2 border rounded-lg" required></select>
                </div>
                <div>
                    <label class="block text-gray-700">Devolução Prevista</label>
                    <input type="date" name="expected_return_date" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-gray-700">Valor do Contrato (R$)</label>
                    <input type="number" name="total_price" class="w-full px-3 py-2 border rounded-lg" step="0.01" required>
                </div>
                <div>
                    <label class="block text-gray-700">Valor do Frete (R$)</label>
                    <input type="number" name="freight" class="w-full px-3 py-2 border rounded-lg" step="0.01" required>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
            <div id="add-expense-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Adicionar Despesa</h2><form id="add-expense-form" class="space-y-4"><div><label class="block text-gray-700">Descrição</label><input type="text" name="description" class="w-full px-3 py-2 border rounded-lg" required></div><div><label class="block text-gray-700">Valor (R$)</label><input type="number" name="amount" class="w-full px-3 py-2 border rounded-lg" step="0.01" required></div><div><label class="block text-gray-700">Data da Transação</label><input type="date" name="transaction_date" class="w-full px-3 py-2 border rounded-lg" required></div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg">Salvar Despesa</button></div></form></div></div>
    <div id="return-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Registrar Devolução</h2><form id="return-form" class="space-y-4"><input type="hidden" name="rental_id"><input type="hidden" name="equipment_id"><div><label class="block text-gray-700">Equipamento</label><p id="return-equipment-name" class="text-lg font-semibold"></p></div><div><label for="actual_return_date" class="block text-gray-700">Data de Devolução</label><input type="date" id="actual_return_date" name="actual_return_date" class="w-full px-3 py-2 border rounded-lg" required></div><div><label for="return-additional-info" class="block text-gray-700">Informações Adicionais (Condição, etc.)</label><textarea id="return-additional-info" name="additional_info" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea></div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg">Confirmar Devolução</button></div></form></div></div>
     <div id="approve-customer-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Aprovar Cliente Pendente</h2>
            <div id="approve-customer-details" class="space-y-2 mb-6 text-gray-700"></div>
            <div class="flex justify-end space-x-4">
                <button type="button" class="cancel-modal-button px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button>
                <button type="button" id="confirm-approve-button" class="px-4 py-2 bg-green-600 text-white rounded-lg">Aprovar Cliente</button>
            </div>
        </div>
    </div>
    
    <!-- NEW MODAL FOR PDF PREVIEW -->
    <div id="pdf-preview-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-6 text-center">Pré-visualização do Contrato</h2>
            <form id="pdf-preview-form" class="flex-grow overflow-y-auto pr-4 space-y-6">
                
                <fieldset class="border p-4 rounded-lg">
                    <legend class="px-2 font-semibold">LOCADORA</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Nome/Razão Social:</label><input type="text" name="locadora_nome" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">CNPJ:</label><input type="text" name="locadora_cnpj" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div class="col-span-2"><label class="block text-sm font-medium text-gray-700">Endereço:</label><input type="text" name="locadora_endereco" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    </div>
                </fieldset>

                <fieldset class="border p-4 rounded-lg">
                    <legend class="px-2 font-semibold">LOCATÁRIO(A)</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="col-span-3"><label class="block text-sm font-medium text-gray-700">Nome Completo:</label><input type="text" name="locatario_nome" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Nacionalidade:</label><input type="text" name="locatario_nacionalidade" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Estado Civil:</label><input type="text" name="locatario_estado_civil" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Profissão:</label><input type="text" name="locatario_profissao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">CPF:</label><input type="text" name="locatario_cpf" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">RG:</label><input type="text" name="locatario_rg" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div class="col-span-3"><label class="block text-sm font-medium text-gray-700">Endereço:</label><input type="text" name="locatario_endereco" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    </div>
                </fieldset>

                <fieldset class="border p-4 rounded-lg">
                    <legend class="px-2 font-semibold">Detalhes da Locação</legend>
                    <div><label class="block text-sm font-medium text-gray-700">Objeto (Descrição do Equipamento):</label><textarea name="objeto_descricao" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div><label class="block text-sm font-medium text-gray-700">Data de Início:</label><input type="date" name="data_inicio" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Data de Fim:</label><input type="date" name="data_fim" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Prazo (dias):</label><input type="number" name="prazo_dias" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    </div>
                </fieldset>
                
                 <fieldset class="border p-4 rounded-lg">
                    <legend class="px-2 font-semibold">Valores e Pagamento</legend>
                     <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Valor Total (R$):</label><input type="number" step="0.01" name="valor_total" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Sinal (R$):</label><input type="number" step="0.01" name="valor_sinal" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="0.00"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Frete (R$):</label><input type="number" step="0.01" name="valor_frete" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Diária Extra (R$):</label><input type="number" step="0.01" name="valor_diaria_extra" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    </div>
                </fieldset>

                <div class="flex justify-end space-x-4 pt-4 mt-auto border-t">
                    <button type="button" class="cancel-modal-button px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Gerar PDF</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 overflow-hidden"></div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://dqzpmwzcpvibjjastcik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxenBtd3pjcHZpYmpqYXN0Y2lrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwODk5NDQsImV4cCI6MjA2NTY2NTk0NH0.sQBEbatxPszUV1KRbV5f7hCO5FJTOesjBllglbjeOYM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let lastFetchedEquipments = [];
        let currentCatalogView = 'grid';

         // --- LÓGICA DE LOGOUT ---
        document.getElementById('logout-button').addEventListener('click', () => {
            sessionStorage.removeItem('isAuthenticated');
            window.location.href = './login.html';
        });

        // --- UI Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const pageSections = document.querySelectorAll('.page-section');
            const pageTitle = document.getElementById('page-title');
            const sidebar = document.getElementById('sidebar');
            const menuButton = document.getElementById('menu-button');
            
            const modals = document.querySelectorAll('.modal');

            // --- Handlers para abrir modais ---
            document.getElementById('add-equipment-catalog-button').addEventListener('click', () => openModal('add-equipment-modal'));
            document.getElementById('make-rental-header-button').addEventListener('click', () => handleRentClick({currentTarget: {dataset: {}}})); // Open with empty data
            document.getElementById('add-customer-button').addEventListener('click', () => openModal('customer-add-choice-modal'));
            document.getElementById('add-expense-button').addEventListener('click', () => openModal('add-expense-modal'));
            document.querySelectorAll('.cancel-modal-button').forEach(b => b.addEventListener('click', () => modals.forEach(m => closeModal(m.id))));
            document.getElementById('cancel-confirmation-button').addEventListener('click', () => closeModal('confirmation-modal'));

            // --- Lógica do modal de escolha de cliente ---
            document.getElementById('add-customer-manually-button').addEventListener('click', () => {
                closeModal('customer-add-choice-modal');
                openModal('add-customer-modal');
            });
            document.getElementById('generate-customer-link-button').addEventListener('click', handleGenerateCustomerLink);
            document.getElementById('copy-link-button').addEventListener('click', copyToClipboard);

            // --- Event Listeners ---
            // Search
            document.getElementById('history-search').addEventListener('input', (e) => fetchRentalHistory(e.target.value));
            document.getElementById('catalog-search').addEventListener('input', triggerCatalogFetch);
            document.getElementById('availability-search').addEventListener('input', (e) => fetchAvailability(e.target.value));
            document.getElementById('customers-search').addEventListener('input', (e) => fetchCustomers(e.target.value));
            
            // Sorting
            document.getElementById('history-sort').addEventListener('change', () => fetchRentalHistory());
            document.getElementById('availability-sort').addEventListener('change', () => fetchAvailability());
            document.getElementById('customers-sort').addEventListener('change', () => fetchCustomers());

            // Filters
            document.getElementById('apply-date-filter').addEventListener('click', triggerCatalogFetch);
            document.getElementById('clear-date-filter').addEventListener('click', () => {
                document.getElementById('filter-start-date').value = '';
                document.getElementById('filter-end-date').value = '';
                triggerCatalogFetch();
            });
            document.getElementById('filter-cashflow-start').addEventListener('change', fetchCashFlow);
            document.getElementById('filter-cashflow-end').addEventListener('change', fetchCashFlow);
            
            document.querySelectorAll('#cashflow-type-filters .filter-btn').forEach(btn => btn.addEventListener('click', () => {
                document.querySelectorAll('#cashflow-type-filters .filter-btn').forEach(b => b.classList.remove('active-filter'));
                btn.classList.add('active-filter');
                fetchCashFlow();
            }));

            document.querySelectorAll('#availability-status-filters .filter-btn').forEach(btn => btn.addEventListener('click', () => {
                document.querySelectorAll('#availability-status-filters .filter-btn').forEach(b => b.classList.remove('active-filter'));
                btn.classList.add('active-filter');
                fetchAvailability();
            }));

            document.querySelectorAll('#customer-status-filters .filter-btn').forEach(btn => btn.addEventListener('click', () => {
                document.querySelectorAll('#customer-status-filters .filter-btn').forEach(b => b.classList.remove('active-filter'));
                btn.classList.add('active-filter');
                fetchCustomers();
            }));
            
            // New Rental Price Calculation
            //document.getElementById('rental-start-date').addEventListener('change', calculateTotalPrice);
            //document.getElementById('rental-return-date').addEventListener('change', calculateTotalPrice);
            //document.getElementById('rental-discount').addEventListener('input', calculateTotalPrice);
            //document.getElementById('new-return-date').addEventListener('change', calculateExtendedTotalPrice);
            //document.getElementById('extend-discount').addEventListener('input', calculateExtendedTotalPrice);

            // Catalog View Switcher
            document.getElementById('grid-view-btn').addEventListener('click', () => switchCatalogView('grid'));
            document.getElementById('list-view-btn').addEventListener('click', () => switchCatalogView('list'));

            // Forms
            document.getElementById('add-equipment-form').addEventListener('submit', handleNewEquipmentSubmit);
            document.getElementById('edit-equipment-form').addEventListener('submit', handleEditEquipmentSubmit);
            document.getElementById('add-customer-form').addEventListener('submit', handleNewClientSubmit);
            document.getElementById('edit-customer-form').addEventListener('submit', handleEditCustomerSubmit);
            document.getElementById('new-rental-form').addEventListener('submit', handleNewRentalSubmit);
            document.getElementById('edit-contract-form').addEventListener('submit', handleEditContractSubmit);
            document.getElementById('add-expense-form').addEventListener('submit', handleNewExpenseSubmit);
            document.getElementById('extend-rental-form').addEventListener('submit', handleExtendRentalSubmit);
            document.getElementById('return-form').addEventListener('submit', handleReturnSubmit);
            document.getElementById('pdf-preview-form').addEventListener('submit', handleGeneratePdfFromForm); // Listener para novo form
            // Catalog Status Filters
            document.querySelectorAll('#catalog-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    document.querySelectorAll('#catalog-filters .filter-btn').forEach(b => b.classList.remove('active-filter'));
                    event.currentTarget.classList.add('active-filter');
                    triggerCatalogFetch();
                });
            });
            
            // --- Initial Load ---
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    pageSections.forEach(s => s.id === targetId ? s.classList.remove('hidden') : s.classList.add('hidden'));
                    pageTitle.textContent = link.textContent.trim();
                    
                    if (targetId === 'historico') fetchRentalHistory();
                    if (targetId === 'catalogo') fetchEquipments();
                    if (targetId === 'disponibilidade') fetchAvailability();
                    if (targetId === 'clientes') fetchCustomers();
                    if (targetId === 'contratos') fetchContracts();
                    if (targetId === 'fluxo-caixa') fetchCashFlow();
                    
                    if (window.innerWidth < 768) sidebar.classList.add('sidebar-closed');
                });
            });

            //sistema de frete
             const rentalInput = document.querySelector('input[name="total_price"]');
            const freightInput = document.querySelector('input[name="freight"]');
            const discountInput = document.querySelector('rental-discount');

            if (rentalInput) rentalInput.addEventListener('input', updateCalculatedTotal);
            if (freightInput) freightInput.addEventListener('input', updateCalculatedTotal);
            if (discountInput) discountInput.addEventListener('input', updateCalculatedTotal);

            switchCatalogView('list'); // Iniciar na visualização de lista
            fetchEquipments(); // Start on catalog view
        });

        function updateCalculatedTotal() {
            const rentalInput = document.querySelector('input[name="total_price"]');
            const freightInput = document.querySelector('input[name="freight"]');
            const discountInput = document.querySelector('rental-discount');

            const rentalValue = parseFloat(rentalInput?.value) || 0;
            const freightValue = parseFloat(freightInput?.value) || 0;
            const discountValue = parseFloat(discountInput?.value) || 0;

            const total = rentalValue + freightValue - discountValue;
            const totalElement = document.getElementById('calculated-total');

            if (totalElement) {
                totalElement.textContent = `R$ ${total.toFixed(2)}`;
            }
        }

        function switchCatalogView(view) {
            currentCatalogView = view;
            const gridBtn = document.getElementById('grid-view-btn');
            const listBtn = document.getElementById('list-view-btn');
            const gridContainer = document.getElementById('grid-view-container');
            const listContainer = document.getElementById('list-view-container');

            if (view === 'grid') {
                gridBtn.classList.add('active-view');
                listBtn.classList.remove('active-view');
                gridContainer.classList.remove('hidden');
                listContainer.classList.add('hidden');
            } else {
                listBtn.classList.add('active-view');
                gridBtn.classList.remove('active-view');
                listContainer.classList.remove('hidden');
                gridContainer.classList.add('hidden');
            }
            renderCatalog();
        }

        function triggerCatalogFetch() {
            const activeFilter = document.querySelector('#catalog-filters .active-filter').dataset.status;
            const searchTerm = document.getElementById('catalog-search').value;
            fetchEquipments(activeFilter === 'Todos' ? null : activeFilter, searchTerm);
        }

        // --- Util Functions ---
        const openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
        const closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => {
            if (!dateString) return '---';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR');
        }
        
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const typeClasses = { success: 'bg-green-500 text-white', error: 'bg-red-500 text-white', info: 'bg-blue-500 text-white' };
            const iconSvg = {
                success: `<svg class="w-6 h-6 mr-3 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`,
                error: `<svg class="w-6 h-6 mr-3 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`,
                info: `<svg class="w-6 h-6 mr-3 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`
            };
            toast.className = `toast flex items-center w-full max-w-xs p-4 rounded-lg shadow-lg ${typeClasses[type] || typeClasses.info}`;
            toast.innerHTML = `${iconSvg[type] || iconSvg.info} <div class="text-sm font-semibold">${message}</div>`;
            toastContainer.prepend(toast);
            requestAnimationFrame(() => { toast.classList.add('show'); });
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 4000);
        }

        /* function calculateTotalPrice() {
           const form = document.getElementById('new-rental-form');
           const startDateValue = form.rental_start_date.value;
            const returnDateValue = form.expected_return_date.value;
            const dailyPrice = parseFloat(form.rental_price.value);
            const discount = parseFloat(form.discount.value) || 0;
            const totalPriceEl = document.getElementById('rental-total-price');
            
            if (!startDateValue || !returnDateValue || !dailyPrice) {
                totalPriceEl.textContent = formatCurrency(0);
                return;
            }
            
            const startDate = new Date(startDateValue + "T00:00:00");
            const returnDate = new Date(returnDateValue + "T00:00:00");
            
            if (returnDate <= startDate) {
                totalPriceEl.textContent = formatCurrency(0);
                return;
            }

            const days = Math.ceil((returnDate - startDate) / (1000 * 60 * 60 * 24));
            const subtotal = days * dailyPrice;
            const total = subtotal - discount;

           totalPriceEl.textContent = formatCurrency(Math.max(0, total));
        } */

        /*function calculateExtendedTotalPrice() {
            const form = document.getElementById('extend-rental-form');
            const newReturnDateValue = form.new_return_date.value;
            const dailyPrice = parseFloat(form.daily_price.value);
            const discount = parseFloat(form.discount.value) || 0;
            const startDate = new Date(form.start_date.value);
            const totalPriceEl = document.getElementById('extend-total-price');

            if (!newReturnDateValue || !dailyPrice) {
                totalPriceEl.textContent = formatCurrency(0);
                return;
            }

            const newReturnDate = new Date(newReturnDateValue + "T00:00:00");
            const days = Math.max(1, Math.ceil((newReturnDate - startDate) / (1000 * 60 * 60 * 24)));
            const subtotal = days * dailyPrice;
            const total = subtotal - discount;

            totalPriceEl.textContent = formatCurrency(Math.max(0, total));
        }*/

        function copyToClipboard() {
            const linkInput = document.getElementById('generated-link-input');
            linkInput.select();
            document.execCommand('copy');
            showToast('Link copiado para a área de transferência!', 'success');
        }

        // --- Core Logic ---
        async function handleGenerateCustomerLink() {
            // 1. Create a placeholder customer record with a temporary name
            const { data, error } = await supabaseClient
                .from('customers')
                .insert({ 
                    name: `[Aguardando Cadastro #${Math.floor(Date.now() / 1000)}]`,
                    situacao_cadastral: 'link_gerado' 
                })
                .select()
                .single();

            if (error) {
                return showToast('Erro ao gerar link: ' + error.message, 'error');
            }

            // 2. Build the URL
            const customerId = data.id;
            const formUrl = new URL('formulario.html', window.location.href);
            formUrl.searchParams.set('customer_id', customerId);

            // 3. Display the link in the modal
            document.getElementById('generated-link-input').value = formUrl.href;
            closeModal('customer-add-choice-modal');
            openModal('generated-link-modal');
            fetchCustomers(); // Refresh customer list
        }

        async function handleNewExpenseSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                transaction_date: formData.get('transaction_date'),
                type: 'Saída'
            };

            if (!data.description || !data.amount || !data.transaction_date) {
                return showToast('Por favor, preencha todos os campos.', 'error');
            }

            const { error } = await supabaseClient.from('cash_flow').insert(data);
            if (error) {
                return showToast('Falha ao adicionar despesa: ' + error.message, 'error');
            }
            
            showToast('Despesa adicionada com sucesso!', 'success');
            e.target.reset();
            closeModal('add-expense-modal');
            fetchCashFlow();
        }

        async function handleNewEquipmentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const { error } = await supabaseClient.from('equipment').insert({ ...data, status: 'Disponível' });
            if (error) return showToast('Falha: ' + error.message, 'error');
            showToast('Equipamento adicionado!', 'success');
            e.target.reset();
            closeModal('add-equipment-modal');
            fetchEquipments();
        }

        async function handleEditEquipmentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const id = data.id;
            delete data.id;
            const { error } = await supabaseClient.from('equipment').update(data).eq('id', id);
            if (error) return showToast('Falha: ' + error.message, 'error');
            showToast('Equipamento atualizado!', 'success');
            e.target.reset();
            closeModal('edit-equipment-modal');
            fetchEquipments();
            fetchAvailability();
        }

        async function handleNewClientSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const { error } = await supabaseClient.from('customers').insert({ ...data, situacao_cadastral: 'ativo' });
            if (error) return showToast('Falha: ' + error.message, 'error');
            showToast('Cliente adicionado!', 'success');
            e.target.reset();
            closeModal('add-customer-modal');
            fetchCustomers();
        }

        async function handleEditCustomerSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const dataToUpdate = Object.fromEntries(formData.entries());
            const id = dataToUpdate.id;
            
            delete dataToUpdate.id;
            delete dataToUpdate.new_comprovante_residencia;
            delete dataToUpdate.new_documento_identidade;

            const newComprovanteFile = form.elements['new_comprovante_residencia'].files[0];
            const newDocumentoFile = form.elements['new_documento_identidade'].files[0];
            
            async function uploadFileForCustomer(nomeCampo, file, customerId) {
                const safeFileName = file.name
                  .normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, '')
                  .replace(/\s/g, '_')
                  .replace(/[^a-zA-Z0-9_.-]/g, '');
                const filePath = `clientes/${customerId}/${nomeCampo}-${Date.now()}-${safeFileName}`;
                const { data, error } = await supabaseClient
                  .storage
                  .from('documentos-clientes')
                  .upload(filePath, file);

                if (error) throw error;
                return data.path;
            }

            try {
                // First, fetch the current customer data to get old file paths
                const { data: currentCustomer, error: fetchError } = await supabaseClient
                    .from('customers')
                    .select('comprovante_residencia_url, documento_identidade_url')
                    .eq('id', id)
                    .single();

                if (fetchError) {
                    throw new Error('Erro ao buscar dados do cliente para atualização: ' + fetchError.message);
                }

                // Handle new proof of residence file
                if (newComprovanteFile) {
                    showToast('Enviando novo comprovante...', 'info');
                    const path = await uploadFileForCustomer('comprovante_residencia', newComprovanteFile, id);
                    dataToUpdate.comprovante_residencia_url = path;
                    
                    // After successful upload, delete the old file if it exists
                    if (currentCustomer.comprovante_residencia_url) {
                        const { error: removeError } = await supabaseClient
                            .storage
                            .from('documentos-clientes')
                            .remove([currentCustomer.comprovante_residencia_url]);
                        
                        if (removeError) {
                            // Log the error but don't stop the process
                            console.error("Erro ao remover comprovante antigo:", removeError.message);
                            showToast('Aviso: Não foi possível remover o arquivo antigo.', 'error');
                        }
                    }
                }

                // Handle new identity document file
                if (newDocumentoFile) {
                    showToast('Enviando novo documento...', 'info');
                    const path = await uploadFileForCustomer('documento_identidade', newDocumentoFile, id);
                    dataToUpdate.documento_identidade_url = path;

                    // After successful upload, delete the old file if it exists
                    if (currentCustomer.documento_identidade_url) {
                        const { error: removeError } = await supabaseClient
                            .storage
                            .from('documentos-clientes')
                            .remove([currentCustomer.documento_identidade_url]);
                        
                        if (removeError) {
                            console.error("Erro ao remover documento antigo:", removeError.message);
                            showToast('Aviso: Não foi possível remover o arquivo antigo.', 'error');
                        }
                    }
                }

                // Update the database with all new information
                if (Object.keys(dataToUpdate).length > 0) {
                    const { error: updateError } = await supabaseClient
                        .from('customers')
                        .update(dataToUpdate)
                        .eq('id', id);

                    if (updateError) throw updateError;
                }
                
                showToast('Cliente atualizado com sucesso!', 'success');
                form.reset();
                closeModal('edit-customer-modal');
                fetchCustomers();

            } catch (error) {
                console.error('Falha ao atualizar cliente:', error);
                showToast('Falha ao atualizar cliente: ' + error.message, 'error');
            }
        }


        async function handleNewRentalSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const dailyPrice = parseFloat(formData.get('rental_price'));
            const startDate = new Date(formData.get('rental_start_date') + "T00:00:00");
            const returnDate = new Date(formData.get('expected_return_date') + "T00:00:00");
            const discount = parseFloat(formData.get('discount')) || 0;
            const totalPrice = parseFloat(formData.get('total_price'));
            const freight = parseFloat(formData.get('freight')) || 0;

            if (returnDate <= startDate) {
                return showToast('A data de devolução deve ser posterior à data de início.', 'error');
            }
            
            const days = Math.ceil((returnDate - startDate) / (1000 * 60 * 60 * 24));
            const total = (days * dailyPrice) - discount;

            const today = new Date();
            today.setHours(0,0,0,0);
            const isFutureRental = startDate > today;
            const status = isFutureRental ? 'Agendado' : 'Ativa';

            const rentalData = {
                equipment_id: formData.get('equipment_id'),
                customer_id: formData.get('customer_id'),
                rental_start_date: startDate.toISOString(),
                expected_return_date: returnDate.toISOString(),
                total_price: totalPrice + freight,
                status: status,
                freight: freight
            };
            
            const { data: conflictingRentals, error: conflictError } = await supabaseClient
                .from('rentals')
                .select('id')
                .eq('equipment_id', rentalData.equipment_id)
                .or(`status.eq.Ativa,status.eq.Agendado`)
                .lte('rental_start_date', rentalData.expected_return_date)
                .gte('expected_return_date', rentalData.rental_start_date);

            if (conflictError) {
                return showToast('Erro ao verificar disponibilidade: ' + conflictError.message, 'error');
            }
            if (conflictingRentals.length > 0) {
                return showToast('Este equipamento já está reservado para o período selecionado.', 'error');
            }

            // --- BUG FIX STARTS HERE ---
            if (isFutureRental) {
                // For future rentals, just insert the record. The availability check prevents double booking.
                const { error } = await supabaseClient.from('rentals').insert([rentalData]);
                if (error) {
                    console.error('Falha ao agendar locação:', error);
                    return showToast('Falha ao agendar locação: ' + error.message, 'error');
                }
            } else {
                // For immediate rentals, call the RPC which also updates equipment status.
                const { error: rpcError } = await supabaseClient.rpc('create_rental_and_update_equipment', { 
                    p_equipment_id: parseInt(rentalData.equipment_id), 
                    p_customer_id: parseInt(rentalData.customer_id), 
                    p_rental_start_date: rentalData.rental_start_date, 
                    p_expected_return_date: rentalData.expected_return_date, 
                    p_total_price: rentalData.total_price 
                });
                
                if (rpcError) {
                    console.error('Falha na chamada RPC para locação:', rpcError);
                    return showToast('Falha na locação: ' + rpcError.message, 'error');
                }
            }
            // --- BUG FIX ENDS HERE ---

            showToast('Locação registrada com sucesso!', 'success');
            e.target.reset();
            closeModal('new-rental-modal');
            fetchAvailability();
            fetchRentalHistory();
            fetchContracts();
            fetchCashFlow();
        }

        // FUNÇÃO DE SUBMISSÃO DO CONTRATO - MODIFICADA
        async function handleEditContractSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rentalId = formData.get('rental_id');

            const updateData = {
                customer_id: formData.get('customer_id'),
                expected_return_date: formData.get('expected_return_date'),
                total_price: parseFloat(formData.get('total_price')),
                freight: parseFloat(formData.get('freight')) || 0 // Tornar o frete opcional
            };

            if (isNaN(updateData.total_price) || isNaN(updateData.freight)) {
                return showToast('Os valores de contrato e frete devem ser números válidos.', 'error');
            }

            const { error } = await supabaseClient
                .from('rentals')
                .update(updateData)
                .eq('id', rentalId);

            if (error) {
                return showToast('Falha ao atualizar o contrato: ' + error.message, 'error');
            }
            
            showToast('Contrato atualizado com sucesso!', 'success');
            e.target.reset();
            closeModal('edit-contract-modal');
            
            // Recarrega os dados relevantes na tela
            fetchAvailability();
            fetchCustomers();
            fetchContracts();
            fetchCashFlow();
        }
        
        async function handleExtendRentalSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const rentalId = parseInt(form.rental_id.value);
            const equipmentId = parseInt(form.equipment_id.value);
            const newReturnDate = form.new_return_date.value;
            const originalReturnDate = form.original_return_date.value;
            const totalPrice = parseFloat(formData.get('total_price'));

            if (new Date(newReturnDate) <= new Date(originalReturnDate)) {
                return showToast('A nova data deve ser posterior à data de devolução original.', 'error');
            }

            const { data: conflictingRentals, error: conflictError } = await supabaseClient
                .from('rentals')
                .select('id')
                .eq('equipment_id', equipmentId)
                .neq('id', rentalId)
                .lt('rental_start_date', newReturnDate)
                .gt('rental_start_date', originalReturnDate);

            if(conflictError) return showToast('Erro ao verificar disponibilidade: ' + conflictError.message, 'error');

            if(conflictingRentals.length > 0) {
                return showToast('Conflito de agendamento. O equipamento já está reservado para este período.', 'error');
            }
            
            const dailyPrice = parseFloat(form.daily_price.value);
            const discount = parseFloat(form.discount.value) || 0;
            const startDate = new Date(form.start_date.value);
            const newEndDate = new Date(newReturnDate);
            const newDuration = Math.max(1, Math.ceil((newEndDate - startDate) / (1000 * 60 * 60 * 24)));
            const newTotalPrice = (newDuration * dailyPrice) - discount;

            const { error: updateError } = await supabaseClient.from('rentals').update({ expected_return_date: newReturnDate, total_price: newTotalPrice }).eq('id', rentalId);
            
            if(updateError) return showToast('Erro ao estender o contrato: ' + updateError.message, 'error');

            showToast('Contrato estendido com sucesso!', 'success');
            closeModal('extend-rental-modal');
            fetchContracts();
            fetchRentalHistory();
            fetchCashFlow();
        }

        async function handleReturnSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            try {
                const { error } = await supabaseClient.rpc('process_equipment_return', { 
                    p_rental_id: parseInt(data.rental_id), 
                    p_equipment_id: parseInt(data.equipment_id),
                    p_actual_return_date: data.actual_return_date,
                    p_additional_info: data.additional_info
                });
                if(error) throw error;
                showToast('Devolução registrada com sucesso!', 'success');
                e.target.reset();
                closeModal('return-modal');
                fetchAvailability();
                fetchRentalHistory();
                fetchCashFlow();
                fetchContracts();
            } catch (error) {
                showToast('Falha ao registrar devolução: ' + error.message, 'error');
            }
        }
        
        async function fetchCustomers(searchTerm = '') {
            const sortValue = document.getElementById('customers-sort').value.split('-');
            const sortColumn = sortValue[0];
            const sortAscending = sortValue[1] === 'asc';
            const statusFilter = document.querySelector('#customer-status-filters .active-filter').dataset.status;

            let query = supabaseClient
                .from('customers')
                .select('*, rentals(status)')
                .order(sortColumn, { ascending: sortAscending });

            if(searchTerm) query = query.ilike('name', `%${searchTerm}%`);
            if (statusFilter !== 'Todos') query = query.eq('situacao_cadastral', statusFilter);

            const { data, error } = await query;
            if (error) return showToast('Erro ao buscar clientes.', 'error');

            const statusColors = {
                'ativo': 'bg-green-100 text-green-800',
                'pendente': 'bg-yellow-100 text-yellow-800',
                'link_gerado': 'bg-blue-100 text-blue-800'
            };
            const statusText = {
                'ativo': 'Ativo',
                'pendente': 'Pendente',
                'link_gerado': 'Aguardando Cadastro'
            };
            
            const tableBody = document.getElementById('customers-table-body');
            tableBody.innerHTML = data.map(customer => {
                const hasActiveRental = customer.rentals.some(rental => rental.status === 'Ativa');
                const rentalStatusHtml = hasActiveRental 
                    ? `<span class="px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800">Com equipamento</span>`
                    : `<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Livre</span>`;
                
                let actionsHtml = `<button data-id="${customer.id}" class="edit-customer-button text-yellow-500 hover:text-yellow-700 p-1">Editar</button>
                                    <button data-id="${customer.id}" class="delete-customer-button text-red-500 hover:text-red-700 p-1 ml-2">Excluir</button>`;
                if (customer.situacao_cadastral === 'pendente') {
                    actionsHtml += `<button data-id="${customer.id}" class="approve-customer-button bg-green-500 text-white px-3 py-1 rounded text-sm ml-2">Aprovar</button>`;
                }

                return `
                    <tr class="border-b">
                        <td class="py-2 px-4">${customer.name || '---'}</td>
                        <td class="py-2 px-4">${customer.phone || '---'}</td>
                        <td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${statusColors[customer.situacao_cadastral] || 'bg-gray-100'}">${statusText[customer.situacao_cadastral] || 'N/A'}</span></td>
                        <td class="py-2 px-4 text-center">${customer.name ? rentalStatusHtml : '---'}</td>
                        <td class="py-2 px-4 text-center">${actionsHtml}</td>
                    </tr>`;
            }).join('');
            document.querySelectorAll('.edit-customer-button').forEach(b => b.addEventListener('click', handleEditCustomerClick));
            document.querySelectorAll('.approve-customer-button').forEach(b => b.addEventListener('click', handleApproveCustomerClick));
            document.querySelectorAll('.delete-customer-button').forEach(b => b.addEventListener('click', handleDeleteCustomerClick));
        }

            async function handleDeleteCustomerClick(e) {
                const customerId = e.currentTarget.dataset.id;
                const confirmBtn = document.getElementById('confirm-action-button');

                if (!customerId) {
                    showToast('ID do cliente não encontrado.', 'error');
                    return;
                }

                document.getElementById('confirmation-title').textContent = 'Excluir Cliente Permanentemente';
                document.getElementById('confirmation-message').textContent =
                    'Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita e todos os dados do cliente serão removidos.';

                openModal('confirmation-modal');

                const confirmHandler = async () => {
                    closeModal('confirmation-modal');

                    const { error } = await supabaseClient
                        .from('customers')
                        .delete()
                        .eq('id', customerId);

                    if (error) {
                        console.error('Erro ao excluir cliente:', error);
                        showToast('Falha ao excluir cliente: ' + error.message, 'error');
                    } else {
                        showToast('Cliente excluído com sucesso!', 'success');
                        fetchCustomers();
                    }
                };

                confirmBtn.addEventListener('click', confirmHandler, { once: true });
            }


        async function fetchRentalHistory(searchTerm = '') {
            const sortValue = document.getElementById('history-sort').value.split('-');
            const sortColumn = sortValue[0];
            const sortAscending = sortValue[1] === 'asc';
            
            let query = supabaseClient
                .from('rentals')
                .select('*, equipment(name), customers(id, name)')
                .eq('status', 'Concluída')
                .order(sortColumn, { ascending: sortAscending });
            
            const { data, error } = await query;
            if (error) return showToast('Erro ao buscar histórico.', 'error');

            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredData = searchTerm 
                ? data.filter(r => (r.equipment?.name?.toLowerCase() || '').includes(lowerCaseSearchTerm) || (r.customers?.name?.toLowerCase() || '').includes(lowerCaseSearchTerm)) 
                : data;
            
            const tableBody = document.getElementById('rental-history-table-body');
            tableBody.innerHTML = filteredData.map(r => {
                return `<tr class="border-b">
                            <td class="py-2 px-4">${r.equipment?.name || 'N/A'}</td>
                            <td class="py-2 px-4">${r.customers?.name || 'N/A'}</td>
                            <td class="py-2 px-4">${formatDate(r.rental_start_date)}</td>
                            <td class="py-2 px-4">${formatDate(r.expected_return_date)}</td>
                            <td class="py-2 px-4">${formatDate(r.actual_return_date)}</td>
                            <td class="py-2 px-4 text-right">${formatCurrency(r.total_price)}</td>
                            <td class="py-2 px-4 text-center">
                                <button data-id="${r.id}" class="delete-history-button text-red-500 hover:text-red-700 p-1">Excluir</button>
                            </td>
                        </tr>`;
            }).join('');
            document.querySelectorAll('.delete-history-button').forEach(b => b.addEventListener('click', handleDeleteHistoryClick));
        }
        
        function renderCatalog() {
            const isDateFilterActive = document.getElementById('filter-start-date').value && document.getElementById('filter-end-date').value;

            if (currentCatalogView === 'grid') {
                const gridElement = document.getElementById('equipment-list-grid');
                if (lastFetchedEquipments.length === 0) {
                     gridElement.innerHTML = `<p class="text-gray-500 col-span-full">Nenhum equipamento encontrado para os filtros aplicados.</p>`;
                     return;
                }
                gridElement.innerHTML = lastFetchedEquipments.map(eq => {
                    let statusText, statusColor, rentalInfoHtml = '';

                    if (isDateFilterActive) {
                        statusText = 'Disponível';
                        statusColor = 'bg-green-100 text-green-800';
                    } else {
                        statusText = eq.status;
                        statusColor = eq.status === 'Disponível' ? 'bg-green-100 text-green-800' : (eq.status === 'Alugado' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                        if (eq.status === 'Alugado') {
                            const activeRental = eq.rentals.find(r => r.status === 'Ativa');
                            if (activeRental) {
                                rentalInfoHtml = `<p class="text-sm text-gray-600 mt-1">Devolução em: ${formatDate(activeRental.expected_return_date)}</p>`;
                            }
                        }
                    }

                    return `<div class="equipment-card bg-white rounded-lg shadow-md overflow-hidden flex flex-col transition-all duration-300 ease-in-out hover:shadow-xl hover:-translate-y-2 cursor-pointer" data-id="${eq.id}">
                                <img src="${eq.image_url || 'https://placehold.co/600x400/e2e8f0/cbd5e0?text=Sem+Imagem'}" alt="${eq.name}" class="w-full h-48 object-cover">
                                <div class="p-4 flex-grow">
                                    <h3 class="text-lg font-semibold">${eq.name}</h3>
                                    ${rentalInfoHtml}
                                    <div class="flex justify-between items-center mt-2">
                                        
                                        <span class="text-sm font-medium px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                                    </div>
                                    <div class="mt-4 text-right">
                                        <button data-id="${eq.id}" class="delete-equipment-button bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Excluir</button>
                                    </div>
                                </div>
                            </div>`;
                }).join('');
            } else { // List View
                const tableBody = document.getElementById('equipment-list-table');
                 if (lastFetchedEquipments.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhum equipamento encontrado para os filtros aplicados.</td></tr>`;
                     return;
                }
                tableBody.innerHTML = lastFetchedEquipments.map(eq => {
                    let statusText, statusColor;
                    if (isDateFilterActive) {
                        statusText = 'Disponível';
                        statusColor = 'bg-green-100 text-green-800';
                    } else {
                        statusText = eq.status;
                        statusColor = eq.status === 'Disponível' ? 'bg-green-100 text-green-800' : (eq.status === 'Alugado' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                    }

                    return `<tr class="border-b hover:bg-gray-50 cursor-pointer equipment-card" data-id="${eq.id}">
                                <td class="py-2 px-4 font-medium">${eq.name}</td>
                                <td class="py-2 px-4">
                                    <span class="text-sm font-medium px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                                </td>
                                
                                <td class="py-2 px-4 text-center">
                                    <button class="text-blue-600 hover:underline text-sm" onclick="handleEquipmentCardClick(event)">Ver Detalhes</button>
                                    <button data-id="${eq.id}" class="delete-equipment-button text-red-500 hover:text-red-700 p-1 ml-2">Excluir</button>
                                </td>
                            </tr>`;
                }).join('');
            }
            document.querySelectorAll('.equipment-card').forEach(c => c.addEventListener('click', handleEquipmentCardClick));
            document.querySelectorAll('.delete-equipment-button').forEach(b => b.addEventListener('click', handleDeleteEquipmentClick));
        }

        async function fetchEquipments(statusFilter = null, searchTerm = '') {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const isDateFilterActive = startDate && endDate;

            let query = supabaseClient.from('equipment').select('*, rentals(*, customers(name))');

            // --- FILTRAGEM ---
            if (isDateFilterActive) {
                if (new Date(startDate) > new Date(endDate)) {
                    return showToast('A data de início não pode ser maior que a data de fim.', 'error');
                }
                const { data: unavailableRentals, error: rentalError } = await supabaseClient
                    .from('rentals')
                    .select('equipment_id')
                    .or(`status.eq.Ativa,status.eq.Agendado`)
                    .lte('rental_start_date', endDate) 
                    .gte('expected_return_date', startDate);
                
                if (rentalError) return showToast('Erro ao filtrar por data.', 'error');

                if (unavailableRentals.length > 0) {
                    const unavailableIds = unavailableRentals.map(r => r.equipment_id);
                    query = query.not('id', 'in', `(${[...new Set(unavailableIds)].join(',')})`);
                }
                query = query.not('status', 'eq', 'Em Reparo');

            } else {
                if (statusFilter && statusFilter !== 'Todos') {
                     query = query.eq('status', statusFilter);
                }
            }
            
            if (searchTerm) {
                query = query.ilike('name', `%${searchTerm}%`);
            }
            
            query = query.order('name');
            const { data, error } = await query;
            if (error) return showToast('Erro ao buscar equipamentos.', 'error');
            
            lastFetchedEquipments = data;
            renderCatalog();
        }
        
        async function fetchAvailability(searchTerm = '') {
            const sortValue = document.getElementById('availability-sort').value.split('-');
            const sortColumn = sortValue[0];
            const sortAscending = sortValue[1] === 'asc';
            const statusFilter = document.querySelector('#availability-status-filters .active-filter').dataset.status;

            let query = supabaseClient
                .from('equipment')
                .select('*, rentals (*, customers (name))')
                .order(sortColumn, { ascending: sortAscending });

            if (statusFilter !== 'Todos') {
                query = query.eq('status', statusFilter);
            }
            if(searchTerm) query = query.ilike('name', `%${searchTerm}%`);
            const { data, error } = await query;
            if (error) return showToast('Erro ao verificar disponibilidade.', 'error');
            const tableBody = document.getElementById('availability-table-body');
            tableBody.innerHTML = '';
            data.forEach(eq => {
                const activeRental = eq.rentals.find(r => r.status === 'Ativa');
                const statusColor = eq.status === 'Disponível' ? 'bg-green-100 text-green-800' : (eq.status === 'Alugado' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                let actionsCell = `<button data-id="${eq.id}" class="edit-button bg-yellow-400 text-yellow-900 hover:bg-yellow-500 font-semibold py-1 px-3 rounded-md text-xs">Editar</button>`;
                
                if (eq.status !== 'Em Reparo') {
                     const nextAvailableDate = activeRental ? activeRental.expected_return_date : '';
                     actionsCell += `<button data-id="${eq.id}" data-name="${eq.name}" data-price="${eq.rental_price}" data-next-available="${nextAvailableDate}" class="rent-button bg-blue-500 text-white px-3 py-1 rounded text-sm ml-2">Alugar</button>`;
                }
                
                if (activeRental) {
                    actionsCell += `<button data-rental-id="${activeRental.id}" data-equipment-id="${eq.id}" class="return-button bg-green-500 text-white px-3 py-1 rounded text-sm ml-2">Devolver</button>`;
                }

                row.innerHTML = `<td class="py-2 px-4">${eq.name}</td><td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${statusColor}">${eq.status}</span></td><td class="py-2 px-4">${activeRental?.customers?.name || '---'}</td><td class="py-2 px-4">${formatDate(activeRental?.expected_return_date)}</td><td class="py-2 px-4 text-center">${actionsCell}</td>`;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.rent-button').forEach(b => b.addEventListener('click', handleRentClick));
            document.querySelectorAll('.return-button').forEach(b => b.addEventListener('click', handleReturnClick));
            document.querySelectorAll('.edit-button').forEach(b => b.addEventListener('click', (e) => openEditModal(e.target.dataset.id)));
        }

        async function fetchContracts() {
            const { data, error } = await supabaseClient
                .from('rentals')
                .select(`
                    id,
                    rental_start_date,
                    expected_return_date,
                    total_price,
                    status,
                    equipment(id, name, rental_price),
                    customers(*)
                `)
                .or('status.eq.Ativa,status.eq.Agendado')
                .order('expected_return_date', { ascending: true });

            if (error) return showToast('Erro ao buscar contratos: ' + error.message, 'error');

            const tableBody = document.getElementById('contracts-table-body');
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum contrato ativo ou agendado no momento.</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = data.map(contract => {
                const statusColors = {
                    'Ativa': 'bg-yellow-100 text-yellow-800',
                    'Agendado': 'bg-blue-100 text-blue-800'
                };
                const statusColor = statusColors[contract.status] || 'bg-gray-100 text-gray-800';
                
                return `
                <tr class="border-b">
                    <td class="py-2 px-4">${contract.equipment.name}</td>
                    <td class="py-2 px-4">${contract.customers.name}</td>
                    <td class="py-2 px-4">${formatDate(contract.rental_start_date)}</td>
                    <td class="py-2 px-4">${formatDate(contract.expected_return_date)}</td>
                    <td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${statusColor}">${contract.status}</span></td>
                    <td class="py-2 px-4 text-right">${formatCurrency(contract.total_price)}</td>
                    <td class="py-2 px-4 text-center">
                         <button data-rental-id="${contract.id}" 
                                 data-customer-id="${contract.customers?.id || ''}"
                                 data-start-date="${contract.rental_start_date}"
                                 data-daily-price="${contract.equipment.rental_price}"
                                 data-equipment-name="${contract.equipment?.name || 'N/A'}"
                                 data-return-date="${contract.expected_return_date}"
                                 class="edit-contract-button text-yellow-500 hover:text-yellow-700 p-1">Editar</button>
                        <button class="extend-button bg-blue-500 text-white px-3 py-1 rounded text-sm ml-2"
                                data-rental-id="${contract.id}"
                                data-equipment-id="${contract.equipment.id}"
                                data-equipment-name="${contract.equipment.name}"
                                data-start-date="${contract.rental_start_date}"
                                data-daily-price="${contract.equipment.rental_price}"
                                data-original-return-date="${contract.expected_return_date}">Estender</button>
                        <button class="generate-pdf-button bg-gray-500 text-white px-3 py-1 rounded text-sm ml-2" data-contract='${JSON.stringify(contract)}'>PDF</button>
                    </td>
                </tr>
            `}).join('');
            document.querySelectorAll('.edit-contract-button').forEach(btn => btn.addEventListener('click', handleEditContractClick));
            document.querySelectorAll('.extend-button').forEach(btn => btn.addEventListener('click', handleExtendClick));
            document.querySelectorAll('.generate-pdf-button').forEach(btn => btn.addEventListener('click', handleGeneratePDFClick));
        }

        function handleGeneratePDFClick(e) {
            const contractData = JSON.parse(e.currentTarget.dataset.contract);
            populatePdfPreviewForm(contractData);
            openModal('pdf-preview-modal');
        }

        // NEW: This function populates the new modal with contract data
        function populatePdfPreviewForm(contract) {
            const form = document.getElementById('pdf-preview-form');
            const customer = contract.customers || {};
            
            // Locadora (Landlord) - Fill with default or stored values
            form.elements['locadora_nome'].value = 'BIO POLTRONAS LOCAÇÕES NITERÓI-RJ LTDA';
            form.elements['locadora_cnpj'].value = '61.053.004/0001-22'; // Example CNPJ
            form.elements['locadora_endereco'].value = 'Itaipu, Niterói/RJ'; // Example Address

            // Locatário (Tenant)
            form.elements['locatario_nome'].value = customer.name || '';
            form.elements['locatario_nacionalidade'].value = customer.nacionalidade || 'Brasileiro(a)';
            form.elements['locatario_estado_civil'].value = customer.estado_civil || '';
            form.elements['locatario_profissao'].value = customer.profissao || '';
            form.elements['locatario_cpf'].value = customer.cpf || '';
            form.elements['locatario_rg'].value = customer.rg || '';
            form.elements['locatario_endereco'].value = customer.endereco_completo || '';

            // Object
            form.elements['objeto_descricao'].value = `01 (uma) Poltrona Elétrica Pós-Operatório, com mecanismo lift, reclínio automático, em corino bege, porta-copos na cor preta, controle com fio, fonte de energia nova e capa dupla face impermeável`;

            // Dates and Duration
            const startDate = new Date(contract.rental_start_date);
            const endDate = new Date(contract.expected_return_date);
            
            // Correct for timezone issues when displaying in input type="date"
            startDate.setMinutes(startDate.getMinutes() + startDate.getTimezoneOffset());
            endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset());

            form.elements['data_inicio'].value = startDate.toISOString().split('T')[0];
            form.elements['data_fim'].value = endDate.toISOString().split('T')[0];
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            form.elements['prazo_dias'].value = duration;

            // Values
            form.elements['valor_total'].value = contract.total_price || 0.00;
            form.elements['valor_frete'].value = contract.freight || 0.00;
            form.elements['valor_sinal'].value = ''; // You might need to add a "deposit" field to your rentals table
            form.elements['valor_diaria_extra'].value = '80.00'; // Default value, can be changed
        }

        // NEW: Handles the submission of the preview form and calls the PDF generation
        function handleGeneratePdfFromForm(e) {
            e.preventDefault();
            const formData = Object.fromEntries(new FormData(e.target).entries());
            generateContractPDF(formData);
            closeModal('pdf-preview-modal');
        }

        // REWRITTEN: Generates the PDF based on the preview form data, matching the new layout
        function generateContractPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
            let y = 0;
            let splitText;

            const checkPageBreak = (spaceNeeded) => {
                if (y + spaceNeeded > 280) { 
                    doc.addPage();
                    y = 20; 
                }
            };

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("CONTRATO DE LOCAÇÃO DE POLTRONA ELÉTRICA PÓS-OPERATÓRIO", 105, 15, { align: "center", maxWidth: 180 });

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            
            y = 25;
            const partiesText = `Pelo presente instrumento particular, de um lado ${data.locadora_nome}, inscrita no CNPJ nº ${data.locadora_cnpj}, com sede em ${data.locadora_endereco}, doravante denominada simplesmente LOCADORA, e de outro lado ${data.locatario_nome}, nacionalidade ${data.locatario_nacionalidade}, estado civil ${data.locatario_estado_civil}, profissão ${data.locatario_profissao}, portador(a) do RG nº ${data.locatario_rg} e do CPF nº ${data.locatario_cpf}, residente e domiciliado(a) na ${data.locatario_endereco}, doravante denominado(a) simplesmente LOCATÁRIO(A), têm entre si, justo e contratado, o presente Contrato de Locação de Poltrona Elétrica Pós-Operatório, que se regerá pelas cláusulas e condições a seguir:`;
            splitText = doc.splitTextToSize(partiesText, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 5;
            
            checkPageBreak(20);
            doc.setFont("helvetica", "bold");
            doc.text("CLÁUSULA 1 - OBJETO E PRAZO DE LOCAÇÃO", 15, y); y += 6;
            doc.setFont("helvetica", "normal");
            const clause1Text = `O presente contrato tem por objeto a locação de ${data.objeto_descricao}, pelo prazo de ${data.prazo_dias} dias, contados a partir de ${formatDate(data.data_inicio)} conforme acordado entre as partes.`;
            splitText = doc.splitTextToSize(clause1Text, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 5;

            checkPageBreak(40);
            doc.setFont("helvetica", "bold");
            doc.text("CLÁUSULA 2 - VALOR E FORMA DE PAGAMENTO", 15, y); y += 6;
            doc.setFont("helvetica", "normal");
            const saldo = (parseFloat(data.valor_total) - parseFloat(data.valor_sinal || 0)).toFixed(2);
            const clause2Text = `O valor total da locação é de R$ ${parseFloat(data.valor_total).toFixed(2)} pelo período contratado de ${data.prazo_dias} dias. O pagamento será feito da seguinte forma:\n- Sinal no valor de R$ ${parseFloat(data.valor_sinal || 0).toFixed(2)} pago no ato da reserva;\n- Saldo de R$ ${saldo} a ser quitado no ato da entrega da poltrona, por meio de dinheiro, PIX ou cartão (crédito ou débito no crédito sujeito a acréscimo de juros da operadora em até 12x).\nO valor do frete é de R$ ${parseFloat(data.valor_frete).toFixed(2)}, pago juntamente com o saldo da locação.`;
            splitText = doc.splitTextToSize(clause2Text, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`Parágrafo 1°: Caso o(a) LOCATÁRIO(A) deseje prorrogar o prazo de locação, deverá consultar previamente a disponibilidade junto à LOCADORA. Sendo possível a prorrogação, o valor da diária extra será de R$ ${parseFloat(data.valor_diaria_extra).toFixed(2)} por dia.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`Parágrafo 2°: Em caso de devolução antecipada da poltrona, não haverá devolução nem reembolso dos valores pagos.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 5;
            
            checkPageBreak(35);
            doc.setFont("helvetica", "bold");
            doc.text("CLÁUSULA 3 - MULTAS CONTRATUAIS", 15, y); y += 6;
            doc.setFont("helvetica", "normal");
            splitText = doc.splitTextToSize(`Parágrafo 1°: Em caso de não devolução da poltrona no prazo estipulado, será aplicada multa de R$100,00 (cem reais) por dia de atraso.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`Parágrafo 2°: O(a) LOCATÁRIO(A) será responsável por qualquer dano causado ao bem locado. A multa compensatória será de R$250,00 (duzentos e cinquenta reais) por item danificado, ou de R$5.000,00 (cinco mil reais) caso seja necessária a substituição integral da poltrona.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`Parágrafo 3º: A não devolução da poltrona após 05 (cinco) dias do vencimento do contrato acarretará multa de R$5.000,00 (cinco mil reais), além das diárias de atraso.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 5;

            checkPageBreak(45);
            doc.setFont("helvetica", "bold");
            doc.text("CLÁUSULA 4 - RESPONSABILIDADE PELOS DANOS", 15, y); y += 6;
            doc.setFont("helvetica", "normal");
            splitText = doc.splitTextToSize(`O(a) LOCATÁRIO(A) compromete-se a zelar pela poltrona, utilizando-a com todo o cuidado necessário. Em caso de danos, o(a) LOCATÁRIO(A) responderá pelos custos de reparo ou, se irreparável, pelo valor de reposição da poltrona, conforme avaliação da LOCADORA.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`Ao final do contrato, a poltrona deverá ser devolvida nas mesmas condições de limpeza e conservação em que foi entregue. É obrigatório o uso da capa protetora, sob pena de cobrança pelos custos de limpeza, reparo e eventuais perdas e danos.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`Parágrafo único: A LOCADORA se compromete a realizar o reparo ou a substituição da poltrona objeto da locação com a máxima urgência, caso seja identificado qualquer problema em seu mecanismo.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 5;

            checkPageBreak(30);
            doc.setFont("helvetica", "bold");
            doc.text("CLÁUSULA 5 - RESCISÃO CONTRATUAL", 15, y); y += 6;
            doc.setFont("helvetica", "normal");
            splitText = doc.splitTextToSize(`Em caso de desistência por parte do(a) LOCATÁRIO(A), este deverá comunicar à LOCADORA com, no mínimo, 15 (quinze) dias de antecedência, arcando com multa rescisória no valor correspondente ao sinal pago.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`A LOCADORA poderá rescindir este contrato, de forma imediata, caso haja descumprimento de qualquer cláusula, sem prejuízo da cobrança dos valores devidos até a data da rescisão.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 5;

            checkPageBreak(40);
            doc.setFont("helvetica", "bold");
            doc.text("CLÁUSULA 6 - DISPOSIÇÕES GERAIS", 15, y); y += 6;
            doc.setFont("helvetica", "normal");
            splitText = doc.splitTextToSize(`6.1. O(a) LOCATÁRIO(A) não poderá sublocar, ceder ou transferir, total ou parcialmente, os direitos sobre o objeto deste contrato sem a prévia autorização da LOCADORA.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`6.2. Qualquer alteração neste contrato só terá validade se feita por escrito e assinada por ambas as partes.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 2;
            splitText = doc.splitTextToSize(`6.3. As partes elegem o foro da Comarca de Niterói/RJ, para dirimir quaisquer dúvidas ou litígios oriundos deste contrato, renunciando a qualquer outro, por mais privilegiado que seja.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 8;
            
            checkPageBreak(15);
            splitText = doc.splitTextToSize(`E, por estarem assim justos e contratados, firmam o presente instrumento, em via de igual teor e forma, para que produza seus legais e jurídicos efeitos.`, 180);
            doc.text(splitText, 15, y);
            y += (splitText.length * 5) + 10;
            
            checkPageBreak(30);
            const today = new Date();
            doc.text(`Niterói, ${today.toLocaleDateString('pt-BR')}`, 105, y, {align: 'center'}); y += 15;
            
            doc.line(20, y, 95, y);
            doc.text(data.locadora_nome, 57.5, y + 5, { align: 'center'});
            doc.text("LOCADORA", 57.5, y + 10, { align: 'center'});
            
            doc.line(115, y, 190, y);
            doc.text(data.locatario_nome, 152.5, y + 5, { align: 'center'});
            doc.text("LOCATÁRIO(A)", 152.5, y + 10, { align: 'center'});

            doc.save(`Contrato_${data.locatario_nome.replace(/\s/g, '_')}.pdf`);
        }

        
        async function fetchCashFlow() {
            const startDate = document.getElementById('filter-cashflow-start').value;
            const endDate = document.getElementById('filter-cashflow-end').value;
            const typeFilter = document.querySelector('#cashflow-type-filters .active-filter').dataset.type;

            let query = supabaseClient.from('cash_flow').select('*').order('transaction_date', { ascending: false });

            if(startDate && endDate) {
                if (new Date(startDate) > new Date(endDate)) {
                    return showToast('A data de início não pode ser maior que a data de fim.', 'error');
                }
                query = query.gte('transaction_date', startDate).lte('transaction_date', endDate);
            }
            if (typeFilter !== 'Todos') {
                query = query.eq('type', typeFilter);
            }

            const { data: transactions, error: transError } = await query;
            if(transError) return showToast('Erro ao buscar fluxo de caixa.', 'error');
            
            let periodIncome = 0;
            let periodExpenses = 0;

            if(transactions) {
                document.getElementById('cash-flow-table-body').innerHTML = transactions.map(t => {
                    const isIncome = t.type === 'Entrada';
                    if(isIncome) {
                        periodIncome += t.amount;
                    } else {
                        periodExpenses += t.amount;
                    }
                    const deleteButton = t.type === 'Saída' ? `<button data-id="${t.id}" class="delete-expense-button text-red-500 hover:text-red-700 p-1">Excluir</button>` : '';

                    return `<tr class="border-b"><td class="py-2 px-4">${formatDate(t.transaction_date)}</td><td class="py-2 px-4">${t.description}</td><td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.type}</span></td><td class="py-2 px-4 text-right font-medium ${isIncome ? 'text-green-600' : 'text-red-600'}">${formatCurrency(t.amount)}</td><td class="py-2 px-4 text-center">${deleteButton}</td></tr>`;
                }).join('');
            }
            
            document.getElementById('total-income').textContent = formatCurrency(periodIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(periodExpenses);
            document.getElementById('net-balance').textContent = formatCurrency(periodIncome - periodExpenses);
            
            document.querySelectorAll('.delete-expense-button').forEach(b => b.addEventListener('click', handleDeleteExpenseClick));


            // Fetch overall balance
            const { data: allTransactions } = await supabaseClient.from('cash_flow').select('amount, type');
            if(allTransactions) {
                const totalBalance = allTransactions.reduce((acc, t) => acc + (t.type === 'Entrada' ? t.amount : -t.amount), 0);
                document.getElementById('total-balance').textContent = formatCurrency(totalBalance);
            }

            // Fetch forecast income (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString();
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString();
            const { data: forecast, error: forecastError } = await supabaseClient.from('rentals').select('total_price').eq('status', 'Ativa').gte('expected_return_date', firstDay).lte('expected_return_date', lastDay);
            if(forecastError) return showToast('Erro ao buscar previsão de receita.', 'error');
            if(forecast) {
                const forecastSum = forecast.reduce((sum, r) => sum + r.total_price, 0);
                document.getElementById('forecast-income').textContent = formatCurrency(forecastSum);
            }
            
            // Fetch future income
            const { data: futureRentals, error: futureError } = await supabaseClient.from('rentals').select('total_price').gt('rental_start_date', today.toISOString());
            if(futureError) return showToast('Erro ao buscar renda futura.', 'error');
            if(futureRentals) {
                 const futureSum = futureRentals.reduce((sum, r) => sum + r.total_price, 0);
                document.getElementById('future-income').textContent = formatCurrency(futureSum);
            }
        }

        function handleDeleteExpenseClick(e) {
            const expenseId = e.currentTarget.dataset.id;
            const confirmBtn = document.getElementById('confirm-action-button');
            const cancelBtn = document.getElementById('cancel-confirmation-button');
            const modal = document.getElementById('confirmation-modal');
            
            modal.querySelector('#confirmation-title').textContent = 'Excluir Despesa';
            modal.querySelector('#confirmation-message').textContent = 'Tem a certeza que deseja excluir esta despesa? Esta ação não pode ser desfeita.';
            
            openModal('confirmation-modal');

            const confirmHandler = async () => {
                const { error } = await supabaseClient.from('cash_flow').delete().eq('id', expenseId);
                
                closeModal('confirmation-modal');
                if (error) {
                    showToast('Falha ao excluir despesa: ' + error.message, 'error');
                } else {
                    showToast('Despesa excluída com sucesso!', 'success');
                    fetchCashFlow();
                }
                confirmBtn.removeEventListener('click', confirmHandler);
            };
            
            const cancelHandler = () => {
                closeModal('confirmation-modal');
                confirmBtn.removeEventListener('click', confirmHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        function handleDeleteHistoryClick(e) {
            const rentalId = e.currentTarget.dataset.id;
            const confirmBtn = document.getElementById('confirm-action-button');
            
            document.getElementById('confirmation-title').textContent = 'Excluir Registro do Histórico';
            document.getElementById('confirmation-message').textContent = 'Tem a certeza que deseja excluir permanentemente este registro do histórico? Esta ação não pode ser desfeita.';
            
            openModal('confirmation-modal');

            const confirmHandler = async () => {
                const { error } = await supabaseClient.from('rentals').delete().eq('id', rentalId);
                
                closeModal('confirmation-modal');
                if (error) {
                    showToast('Falha ao excluir registro: ' + error.message, 'error');
                } else {
                    showToast('Registro do histórico excluído!', 'success');
                    fetchRentalHistory();
                }
                confirmBtn.removeEventListener('click', confirmHandler);
            };
            
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
        }


        async function openEditModal(equipmentId) {
             const { data, error } = await supabaseClient.from('equipment').select('*').eq('id', equipmentId).single();
            if(error) return showToast("Erro ao carregar dados para edição.", 'error');
            const form = document.getElementById('edit-equipment-form');
            Object.keys(data).forEach(key => { if(form.elements[key]) form.elements[key].value = data[key] || '' });
            openModal('edit-equipment-modal');
        }

        async function handleEquipmentCardClick(event) {
            const card = event.currentTarget;
            const equipmentId = card.dataset.id;
            const { data: equipment, error } = await supabaseClient.from('equipment').select('*, rentals(*, customers(name))').eq('id', equipmentId).single();
            if (error) return showToast('Erro ao carregar detalhes do equipamento.', 'error');

            const modal = document.getElementById('equipment-details-modal');
            modal.querySelector('.equipment-name').textContent = equipment.name;
            modal.querySelector('.equipment-image').src = equipment.image_url || 'https://placehold.co/600x400/e2e8f0/cbd5e0?text=Sem+Imagem';
            modal.querySelector('.equipment-description').textContent = equipment.description || 'Nenhuma descrição.';
            modal.querySelector('.equipment-additional-info').textContent = equipment.additional_info || 'Nenhuma informação adicional.';
            //modal.querySelector('.equipment-price').textContent = formatCurrency(equipment.rental_price) + '/dia';
            modal.querySelector('.equipment-acquisition-date').textContent = formatDate(equipment.acquisition_date);
            
            const editButton = modal.querySelector('.edit-button-modal');
            editButton.onclick = () => {
                closeModal('equipment-details-modal');
                openEditModal(equipmentId);
            };

            const historyTableBody = modal.querySelector('#equipment-rental-history-table');
            const rentals = equipment.rentals.sort((a, b) => new Date(b.rental_start_date) - new Date(a.rental_start_date));
            if (rentals.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="4" class="py-2 px-4 text-center text-gray-500">Nenhum histórico de locação para este item.</td></tr>';
            } else {
                historyTableBody.innerHTML = rentals.map(r => {
                    const statusColor = r.status === 'Ativa' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                    return `<tr class="border-b"><td class="py-2 px-4">${r.customers?.name || 'N/A'}</td><td class="py-2 px-4">${formatDate(r.rental_start_date)}</td><td class="py-2 px-4">${formatDate(r.actual_return_date) || formatDate(r.expected_return_date)}</td><td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${statusColor}">${r.status}</span></td></tr>`;
                }).join('');
            }
            openModal('equipment-details-modal');
        }

        async function handleEditCustomerClick(e) {
            const id = e.currentTarget.dataset.id;
            const { data, error } = await supabaseClient.from('customers').select('*').eq('id', id).single();
            if(error) return showToast("Erro ao carregar dados do cliente.", 'error');

            const form = document.getElementById('edit-customer-form');
            form.id.value = data.id;
            form.name.value = data.name;
            form.phone.value = data.phone || '';
            form.email.value = data.email || '';
            form.address.value = data.address || '';
            
            // Preenche os campos adicionais que você inseriu no modal
            form.cpf.value = data.cpf || '';
            form.rg.value = data.rg || '';
            form.profissao.value = data.profissao || '';
            form.nacionalidade.value = data.nacionalidade || '';
            form.estado_civil.value = data.estado_civil || '';
            form.endereco_completo.value = data.endereco_completo || '';
            form.cidade.value = data.cidade || '';
            form.medico_responsavel.value = data.medico_responsavel || '';
            form.tipo_cirurgia.value = data.tipo_cirurgia || '';
            form.data_cirurgia.value = data.data_cirurgia || '';
            form.indicacao.value = data.indicacao || '';
            // --- FIM DA ADIÇÃO ---

            // --- NEW DOCUMENT LOGIC ---
            const comprovanteStatusDiv = document.getElementById('edit-customer-comprovante-status');
            const documentoStatusDiv = document.getElementById('edit-customer-documento-status');

            form.elements['new_comprovante_residencia'].value = '';
            form.elements['new_documento_identidade'].value = '';

            // Handle Comprovante
            if (data.comprovante_residencia_url) {
                const { data: urlData, error: urlError } = await supabaseClient
                    .storage
                    .from('documentos-clientes')
                    .createSignedUrl(data.comprovante_residencia_url, 60); // URL valid for 60 seconds

                if (urlError) {
                    comprovanteStatusDiv.innerHTML = `<span class="text-red-500">Erro ao carregar link</span>`;
                } else {
                    const fileNameParts = data.comprovante_residencia_url.split('-');
                    const fileName = fileNameParts[fileNameParts.length - 1];
                    comprovanteStatusDiv.innerHTML = `<a href="${urlData.signedUrl}" target="_blank" download class="text-blue-600 hover:underline">Baixar: ${fileName}</a>`;
                }
            } else {
                comprovanteStatusDiv.textContent = 'Nenhum arquivo enviado.';
            }

            // Handle Documento
            if (data.documento_identidade_url) {
                const { data: urlData, error: urlError } = await supabaseClient
                    .storage
                    .from('documentos-clientes')
                    .createSignedUrl(data.documento_identidade_url, 60);

                if (urlError) {
                    documentoStatusDiv.innerHTML = `<span class="text-red-500">Erro ao carregar link</span>`;
                } else {
                    const fileNameParts = data.documento_identidade_url.split('-');
                    const fileName = fileNameParts[fileNameParts.length - 1];
                    documentoStatusDiv.innerHTML = `<a href="${urlData.signedUrl}" target="_blank" download class="text-blue-600 hover:underline">Baixar: ${fileName}</a>`;
                }
            } else {
                documentoStatusDiv.textContent = 'Nenhum arquivo enviado.';
            }

            openModal('edit-customer-modal');
        }

        async function handleApproveCustomerClick(e) {
            const customerId = e.currentTarget.dataset.id;
            const { data, error } = await supabaseClient.from('customers').select('*').eq('id', customerId).single();
            if (error) return showToast("Erro ao carregar dados do cliente.", 'error');

            const detailsDiv = document.getElementById('approve-customer-details');
            detailsDiv.innerHTML = `
                <p><strong>Nome:</strong> ${data.name}</p>
                <p><strong>CPF:</strong> ${data.cpf}</p>
                <p><strong>RG:</strong> ${data.rg}</p>
                <p><strong>Endereço:</strong> ${data.endereco_completo}</p>
                <p><strong>Médico:</strong> ${data.medico_responsavel}</p>
                <p><strong>Cirurgia:</strong> ${data.tipo_cirurgia} em ${formatDate(data.data_cirurgia)}</p>
            `;

            openModal('approve-customer-modal');

            document.getElementById('confirm-approve-button').onclick = async () => {
                const { error: updateError } = await supabaseClient
                    .from('customers')
                    .update({ situacao_cadastral: 'ativo' })
                    .eq('id', customerId);

                if (updateError) {
                    showToast('Erro ao aprovar cliente: ' + updateError.message, 'error');
                } else {
                    showToast('Cliente aprovado com sucesso!', 'success');
                    closeModal('approve-customer-modal');
                    fetchCustomers();
                }
            };
        }


        async function handleEditContractClick(e) {
            const { rentalId, customerId, equipmentName, returnDate, dailyPrice, startDate } = e.currentTarget.dataset;

            const form = document.getElementById('edit-contract-form');
            form.rental_id.value = rentalId;
            form.daily_price.value = dailyPrice;
            form.start_date.value = startDate;

            document.getElementById('edit-contract-equipment-name').textContent = equipmentName;
            
            const date = new Date(returnDate);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const correctedDate = new Date(date.getTime() + userTimezoneOffset);
            form.expected_return_date.value = correctedDate.toISOString().split('T')[0];
            form.expected_return_date.min = form.expected_return_date.value;


            const { data: customers, error } = await supabaseClient.from('customers').select('id, name').order('name');
            if(error) return showToast("Erro ao buscar clientes.", 'error');

            const customerSelect = document.getElementById('edit-contract-customer');
            customerSelect.innerHTML = customers.map(c => `<option value="${c.id}" ${c.id == customerId ? 'selected' : ''}>${c.name}</option>`).join('') || '<option>Cadastre um cliente</option>';
            
            openModal('edit-contract-modal');
        }

        async function handleExtendClick(e) {
            const { rentalId, equipmentId, equipmentName, originalReturnDate, dailyPrice, startDate } = e.currentTarget.dataset;
            
            const form = document.getElementById('extend-rental-form');
            form.rental_id.value = rentalId;
            form.equipment_id.value = equipmentId;
            form.original_return_date.value = originalReturnDate;
            form.daily_price.value = dailyPrice;
            form.start_date.value = startDate;
            document.getElementById('extend-equipment-name').textContent = equipmentName;
            
            const date = new Date(originalReturnDate);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const correctedDate = new Date(date.getTime() + userTimezoneOffset);
            form.new_return_date.value = correctedDate.toISOString().split('T')[0];
            form.new_return_date.min = correctedDate.toISOString().split('T')[0];
            
            //calculateExtendedTotalPrice();
            openModal('extend-rental-modal');
        }

        async function handleRentClick(e) {
            const { id, name, price, nextAvailable } = e.currentTarget.dataset;
            const form = document.getElementById('new-rental-form');
            
            if (id) {
                form.equipment_id.value = id;
                form.rental_price.value = price;
                document.getElementById('rental-equipment-name').textContent = name;
            } else {
                 showToast('Por favor, selecione um equipamento na aba Disponibilidade primeiro.', 'info');
                 document.querySelector('a[href="#disponibilidade"]').click();
                 return;
            }
            
            const { data: customers, error } = await supabaseClient.from('customers').select('id, name').eq('situacao_cadastral', 'ativo').order('name');
            if(error) return showToast("Erro ao buscar clientes.", 'error');
            document.getElementById('rental-customer').innerHTML = customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('') || '<option>Nenhum cliente ativo</option>';
            
            const today = new Date();
            const startDateInput = form.rental_start_date;
            const returnDateInput = form.expected_return_date;

            let defaultStartDate;
            if (nextAvailable) {
                const nextAvailableDate = new Date(nextAvailable);
                nextAvailableDate.setDate(nextAvailableDate.getDate() + 2); // Add 1 day to be available
                defaultStartDate = nextAvailableDate > today ? nextAvailableDate : today;
            } else {
                defaultStartDate = today;
            }
            
            const defaultStartDateString = defaultStartDate.toISOString().split('T')[0];
            
            const defaultReturnDate = new Date(defaultStartDate);
            defaultReturnDate.setDate(defaultReturnDate.getDate() + 1);
            const defaultReturnDateString = defaultReturnDate.toISOString().split('T')[0];
            
            startDateInput.value = defaultStartDateString;
            startDateInput.min = today.toISOString().split('T')[0];
            returnDateInput.value = defaultReturnDateString;
            returnDateInput.min = defaultReturnDateString;

            startDateInput.onchange = () => {
                const newStartDate = new Date(startDateInput.value);
                const nextDay = new Date(newStartDate);
                nextDay.setDate(nextDay.getDate() + 2); 
                returnDateInput.min = nextDay.toISOString().split('T')[0];
                if (new Date(returnDateInput.value) <= newStartDate) {
                   returnDateInput.value = nextDay.toISOString().split('T')[0];
                }
                //calculateTotalPrice();
            };

            //calculateTotalPrice();
            openModal('new-rental-modal');
        }

        async function handleReturnClick(e) {
            const { rentalId, equipmentId } = e.currentTarget.dataset;
            const { data: equipment, error } = await supabaseClient.from('equipment').select('name, additional_info').eq('id', equipmentId).single();

            if (error) return showToast("Erro ao buscar dados do equipamento.", "error");

            const form = document.getElementById('return-form');
            form.rental_id.value = rentalId;
            form.equipment_id.value = equipmentId;
            document.getElementById('return-equipment-name').textContent = equipment.name;
            form.elements.additional_info.value = equipment.additional_info || '';
            form.actual_return_date.valueAsDate = new Date();

            openModal('return-modal');
        }

        async function handleDeleteEquipmentClick(e) {
            e.stopPropagation(); // Evita que o evento do card seja acionado
            const equipmentId = e.currentTarget.dataset.id;
            const confirmBtn = document.getElementById('confirm-action-button');
            const cancelBtn = document.getElementById('cancel-confirmation-button');
            const modal = document.getElementById('confirmation-modal');

            document.getElementById('confirmation-title').textContent = 'Excluir Equipamento';
            document.getElementById('confirmation-message').textContent = 'Tem a certeza que deseja excluir permanentemente este equipamento? Esta ação não pode ser desfeita.';

            openModal('confirmation-modal');

            const confirmHandler = async () => {
                const { error } = await supabaseClient.from('equipment').delete().eq('id', equipmentId);
                
                closeModal('confirmation-modal');
                if (error) {
                    showToast('Falha ao excluir equipamento: ' + error.message, 'error');
                } else {
                    showToast('Equipamento excluído com sucesso!', 'success');
                    fetchEquipments(); // Atualizar a lista após a exclusão
                    fetchAvailability(); // Atualizar a disponibilidade também
                }
                // Remover listeners para evitar múltiplas execuções
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };
            
            const cancelHandler = () => {
                closeModal('confirmation-modal');
                // Remover listeners para evitar múltiplas execuções
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            // Adicionar listeners. Use { once: true } para que sejam executados apenas uma vez
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }
    </script>
</body>
</html>